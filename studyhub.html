<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraLearn: Intelligent Learning Architect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        /* Theme Variables */
        .theme-light {
            --bg-primary:#f8fafc; --bg-secondary:#ffffff; --text-primary:#0f172a; --text-secondary:#64748b;
            --border-color:#e2e8f0; --accent-blue:#2563eb; --accent-blue-hover:#1d4ed8;
            --nav-active-bg:#e2e8f0; --nav-active-text:#0f172a;
            --card-front-bg:#ffffff; --card-back-bg:#ffffff;
            --input-bg:#ffffff; --input-text:#0f172a;
            --text-red:#dc2626; --text-orange:#f97316; --text-yellow:#facc15; --text-green:#22c54a;
            --text-red-rgb:220,38,38; --text-orange-rgb:249,115,22; --text-yellow-rgb:250,204,21; --text-green-rgb:34,197,74;
            --list-item-bg:#ffffff; /* Lighter than secondary for contrast */
            --list-item-border:#e2e8f0;
            --list-item-hover-bg:#f1f5f9;
        }
        .theme-dark {
            --bg-primary:#1e293b; --bg-secondary:#334155; --text-primary:#f8fafc; --text-secondary:#94a3b8;
            --border-color:#475569; --accent-blue:#60a5fa; --accent-blue-hover:#3b82f6;
            --nav-active-bg:#475569; --nav-active-text:#f8fafc;
            --card-front-bg:#334155; --card-back-bg:#334155;
            --input-bg:#1e293b; --input-text:#f8fafc;
            --text-red:#ef4444; --text-orange:#fb923c; --text-yellow:#fde047; --text-green:#4ade80;
            --text-red-rgb:239,68,68; --text-orange-rgb:251,146,60; --text-yellow-rgb:253,224,71; --text-green-rgb:74,222,128;
            --list-item-bg:#2d3a4b; /* Darker for contrast */
            --list-item-border:#475569;
            --list-item-hover-bg:#37455a;
        }
        .theme-vibrant {
            --bg-primary:#ecfeff; --bg-secondary:#e0f2f7; --text-primary:#083344; --text-secondary:#22d3ee;
            --border-color:#a5f3fc; --accent-blue:#0ea5e9; --accent-blue-hover:#0284c7;
            --nav-active-bg:#bae6fd; --nav-active-text:#083344;
            --card-front-bg:#ffffff; --card-back-bg:#ffffff;
            --input-bg:#ecfeff; --input-text:#083344;
            --text-red:#ef4444; --text-orange:#fb923c; --text-yellow:#fde047; --text-green:#4ade80;
            --text-red-rgb:239,68,68; --text-orange-rgb:251,146,60; --text-yellow-rgb:253,224,71; --text-green-rgb:74,222,128;
            --list-item-bg:#e0f2f7;
            --list-item-border:#a5f3fc;
            --list-item-hover-bg:#d1f4ff;
        }

        /* General element styling using variables */
        body { background-color: var(--bg-primary); color: var(--text-primary); }
        aside, header, .bg-secondary, .modal > div { background-color: var(--bg-secondary); border-color: var(--border-color); }
        .text-primary { color: var(--text-primary); } .text-secondary { color: var(--text-secondary); } .border-border-color { border-color: var(--border-color); }
        /* Specific hover state for nav items, using theme var */
        .nav-item:hover { background-color: var(--nav-active-bg); }
        .nav-item-active { background-color: var(--nav-active-bg); color: var(--nav-active-text); font-weight: 600; }
        .bg-accent-blue { background-color: var(--accent-blue); } .hover\:bg-accent-blue-hover:hover { background-color: var(--accent-blue-hover); }
        .text-accent-blue { color: var(--accent-blue); } .bg-border-color { background-color: var(--border-color); }

        /* Input specific styles for theme */
        input[type="text"], input[type="number"], textarea, select {
            background-color: var(--input-bg);
            color: var(--input-text);
            border-color: var(--border-color);
            padding: 0.75rem;
            border-radius: 0.5rem;
        }

        /* Recall button specific styles for theme */
        .recall-btn.bg-red-100 { background-color: rgba(var(--text-red-rgb), 0.1); color: var(--text-red); }
        .recall-btn.bg-orange-100 { background-color: rgba(var(--text-orange-rgb), 0.1); color: var(--text-orange); }
        .recall-btn.bg-yellow-100 { background-color: rgba(var(--text-yellow-rgb), 0.1); color: var(--text-yellow); }
        .recall-btn.bg-green-100 { background-color: rgba(var(--text-green-rgb), 0.1); color: var(--text-green); }

        /* List item styles using new variables */
        .list-item-themed {
            background-color: var(--list-item-bg);
            border-color: var(--list-item-border);
        }
        .list-item-themed:hover {
            background-color: var(--list-item-hover-bg);
        }

        /* Other utility classes */
        .chart-container { position: relative; width: 100%; height: 300px; max-width: 700px; margin-left: auto; margin-right: auto; max-height: 40vh; }
        @media (min-width: 768px) { .chart-container { height: 350px; } }
        .flip-card { transform-style: preserve-3d; transition: transform 0.6s; } .flip-card.flipped { transform: rotateY(180deg); }
        .flip-card-front, .flip-card-back { backface-visibility: hidden; -webkit-backface-visibility: hidden; background-color: var(--card-front-bg); }
        .flip-card-back { transform: rotateY(180deg); background-color: var(--card-back-bg); }
        ::-webkit-scrollbar { width: 8px; } ::-webkit-scrollbar-track { background: var(--bg-primary); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: var(--text-secondary); }
        .modal { background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; }
        
        /* Notification Toast Styling */
        #notification-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4CAF50; /* Green for success */
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
            min-width: 250px;
            text-align: center;
        }
        #notification-toast.show {
            opacity: 1;
            visibility: visible;
        }
        #notification-toast.error {
            background-color: #f44336; /* Red for error */
        }
    </style>
</head>
<body class="theme-light">
    <div id="app-container" class="flex h-screen">
        <aside id="sidebar" class="w-64 bg-secondary border-r border-border-color flex-shrink-0 flex-col hidden md:flex">
            <div class="p-4 border-b border-border-color">
                <h1 class="text-2xl font-bold text-primary">AuraLearn</h1>
                <p class="text-xs text-secondary">Intelligent Learning Architect</p>
            </div>
            <nav class="flex-grow p-4">
                <ul class="space-y-2">
                    <li><a href="#" data-view="dashboard" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                        <span class="w-6 h-6 mr-3">üè†</span>Dashboard</a></li>
                    <li><a href="#" data-view="library" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                        <span class="w-6 h-6 mr-3">üìö</span>Library</a></li>
                    <li><a href="#" data-view="ai-learning" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                        <span class="w-6 h-6 mr-3">‚ú®</span>AI Learning</a></li>
                    <li><a href="#" data-view="analytics" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                        <span class="w-6 h-6 mr-3">üìä</span>Analytics</a></a></li>
                    <li><a href="#" data-view="focus" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                        <span class="w-6 h-6 mr-3">üéß</span>Focus Tools</a></li>
                    <li><a href="#" data-view="learning-hub" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                        <span class="w-6 h-6 mr-3">üß†</span>Learning Hub</a></li>
                    <li><a href="#" data-view="settings" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                        <span class="w-6 h-6 mr-3">‚öôÔ∏è</span>Settings</a></li>
                </ul>
            </nav>
            <div class="p-4 border-t border-border-color">
                <div class="flex items-center">
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold mr-3">U</div>
                    <div>
                        <p class="font-semibold text-primary" id="sidebar-username">User</p>
                        <a href="#" data-view="settings" class="nav-item text-sm text-accent-blue hover:underline">Settings</a>
                    </div>
                </div>
            </div>
        </aside>

        <header class="md:hidden bg-secondary border-b border-border-color p-4 flex justify-between items-center w-full fixed top-0 z-20">
            <h1 class="text-xl font-bold text-primary">AuraLearn</h1>
            <button id="menu-button" class="p-2"><span class="text-2xl">‚ò∞</span></button>
        </header>

        <div id="mobile-sidebar-container" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden modal">
            <aside id="mobile-sidebar" class="w-64 bg-secondary h-full flex-shrink-0 flex-col flex transition-transform transform -translate-x-full">
                 <div class="p-4 border-b border-border-color flex justify-between items-center">
                    <div><h1 class="text-2xl font-bold text-primary">AuraLearn</h1><p class="text-xs text-secondary">Intelligent Learning Architect</p></div>
                    <button id="close-menu-button" class="p-2"><span class="text-2xl">&times;</span></button>
                </div>
                 <nav class="flex-grow p-4">
                    <ul class="space-y-2">
                        <li><a href="#" data-view="dashboard" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                            <span class="w-6 h-6 mr-3">üè†</span>Dashboard</a></li>
                        <li><a href="#" data-view="library" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                            <span class="w-6 h-6 mr-3">üìö</span>Library</a></li>
                        <li><a href="#" data-view="ai-learning" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                            <span class="w-6 h-6 mr-3">‚ú®</span>AI Learning</a></li>
                        <li><a href="#" data-view="analytics" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                            <span class="w-6 h-6 mr-3">üìä</span>Analytics</a></li>
                        <li><a href="#" data-view="focus" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                            <span class="w-6 h-6 mr-3">üéß</span>Focus Tools</a></li>
                        <li><a href="#" data-view="learning-hub" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                            <span class="w-6 h-6 mr-3">üß†</span>Learning Hub</a></li>
                        <li><a href="#" data-view="settings" class="nav-item flex items-center p-2 rounded-lg hover:bg-slate-100 transition-colors">
                            <span class="w-6 h-6 mr-3">‚öôÔ∏è</span>Settings</a></li>
                    </ul>
                </nav>
                <div class="p-4 border-t border-border-color">
                     <div class="flex items-center">
                        <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold mr-3">U</div>
                        <div>
                            <p class="font-semibold text-primary" id="sidebar-username-mobile">User</p>
                            <a href="#" data-view="settings" class="nav-item text-sm text-accent-blue hover:underline">Settings</a>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
        
        <main class="flex-grow p-4 sm:p-6 lg:p-8 overflow-y-auto pt-20 md:pt-6">
            <div class="fixed top-4 right-4 z-40 md:static md:mb-6 md:flex md:justify-end">
                <input type="text" id="global-search-input" placeholder="Search atoms or learning hub..." class="p-2 border border-border-color rounded-lg shadow-sm w-48 md:w-64 bg-input-bg text-input-text focus:outline-none focus:ring-2 focus:ring-accent-blue">
            </div>

            <div id="view-dashboard" class="space-y-8">
                <div>
                    <h2 class="text-3xl font-bold text-primary">Welcome back, <span id="dashboard-username">User</span>!</h2>
                    <p class="text-secondary mt-1">Here's your learning snapshot for today, highlighting key progress and ready actions.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                        <h3 class="text-sm font-medium text-secondary">Daily Learning Queue</h3>
                        <p class="text-3xl font-bold text-primary mt-2" id="daily-queue-count">0 Atoms</p>
                        <p class="text-xs text-secondary mt-1">Ready for optimal review</p>
                    </div>
                    <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                        <h3 class="text-sm font-medium text-secondary">Current Learning Streak</h3>
                        <p class="text-3xl font-bold text-primary mt-2" id="current-streak">üî• 0 Days</p>
                        <p class="text-xs text-secondary mt-1">Consistency builds mastery!</p>
                    </div>
                    <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                        <h3 class="text-sm font-medium text-secondary">Total Atoms Mastered</h3>
                        <p class="text-3xl font-bold text-primary mt-2" id="total-mastered-atoms">0</p>
                        <p class="text-xs text-secondary mt-1">Knowledge that sticks</p>
                    </div>
                </div>
                <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary">Today's Intelligent Review</h3>
                        <button id="quick-add-atom-btn-dashboard" class="bg-accent-blue text-white text-sm font-semibold py-1.5 px-3 rounded-lg hover:bg-accent-blue-hover transition-all shadow-md">
                            + Quick Add Atom
                        </button>
                    </div>
                    <p class="text-secondary mt-1">Your personalized, prioritized list based on AuraLearn's Spaced Repetition algorithm.</p>
                    <ul id="daily-queue-list" class="mt-4 space-y-3"></ul>
                    <button id="start-review-btn" class="mt-6 w-full bg-accent-blue text-white font-semibold py-3 rounded-lg hover:bg-accent-blue-hover transition-all shadow-md hover:shadow-lg">
                        Start Daily Review (0 items)
                    </button>
                </div>

                <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                    <h3 class="text-xl font-bold text-primary mb-4">Recommended for You</h3>
                    <p class="text-secondary mb-4">Based on your learning patterns, here are some atoms AuraLearn recommends you focus on next.</p>
                    <div id="recommended-atoms-list" class="space-y-3">
                        <p class="text-secondary text-center">No recommendations yet. Start importing content!</p>
                    </div>
                </div>

                <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                    <h3 class="text-xl font-bold text-primary mb-4">Daily Challenge</h3>
                    <p class="text-secondary mb-4" id="daily-challenge-text">Review 5 atoms to complete today's challenge!</p>
                    <div class="w-full bg-border-color rounded-full h-2.5">
                        <div id="daily-challenge-progress" class="bg-green-500 h-2.5 rounded-full" style="width: 0%;"></div>
                    </div>
                    <p id="daily-challenge-status" class="text-secondary text-sm mt-2 text-center">0/5 Atoms Reviewed</p>
                    <button id="claim-challenge-btn" class="mt-4 w-full bg-green-600 text-white font-semibold py-2 rounded-lg hover:bg-green-700 transition-all hidden">Claim Reward!</button>
                </div>
            </div>

            <div id="view-library" class="hidden space-y-6">
                <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4">
                    <div>
                        <h2 class="text-3xl font-bold text-primary">Knowledge Library</h2>
                        <p class="text-secondary mt-1">Manage and expand your personal learning content. Import documents and let AuraLearn's AI help structure your knowledge.</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="quick-add-atom-btn-library" class="bg-accent-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-accent-blue-hover transition-all shadow-md">
                            + Quick Add Atom
                        </button>
                    </div>
                </div>
                <div id="library-content" class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                     <h3 class="text-xl font-bold text-primary mb-4">Subjects (Flashcards)</h3>
                     <div id="subject-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
                     <p id="empty-library-message" class="text-secondary text-center mt-8 hidden">
                        Your library is empty! Click "Quick Add Atom" or use the "AI Learning" section to add your first learning materials.
                    </p>
                </div>

                <!-- AI Materials Section -->
                <div id="ai-materials-section" class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color mt-6">
                    <h3 class="text-xl font-bold text-primary mb-4">AI-Generated Materials</h3>
                    <div id="ai-materials-list" class="space-y-4">
                        <p id="empty-ai-materials-message" class="text-secondary text-center">No AI-generated materials yet. Go to 'AI Learning' to create some!</p>
                    </div>
                </div>
            </div>

            <!-- New AI Learning View -->
            <div id="view-ai-learning" class="hidden space-y-8">
                <div>
                    <h2 class="text-3xl font-bold text-primary">AI Learning Studio</h2>
                    <p class="text-secondary mt-1">Generate notes, quizzes, keywords, and exam questions using AI based on your custom input.</p>
                </div>

                <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color space-y-4">
                    <h3 class="text-xl font-bold text-primary mb-4">Content Input</h3>
                    <div class="flex items-center space-x-2 mb-2">
                        <input type="checkbox" id="ai-input-mode-toggle" class="form-checkbox h-4 w-4 text-accent-blue rounded">
                        <label for="ai-input-mode-toggle" class="text-primary text-sm font-semibold">Generate from Topic Name</label>
                    </div>
                    <label for="ai-input-content" class="block text-primary text-sm font-semibold mb-2" id="ai-input-content-label">Provide text, a topic, or questions for the AI to process.</label>
                    <textarea id="ai-input-content" class="w-full h-40 p-3 border border-border-color rounded-lg text-primary" placeholder="Enter text, a topic, or specific questions here... e.g., 'Explain blockchain technology', 'Summarize World War 2 causes', or 'Quiz me on React hooks'." rows="6"></textarea>
                    
                    <div>
                        <label for="ai-content-subject-select" class="block text-primary text-sm font-semibold mb-2">Assign to Subject (Optional for categorization, required for Flashcards):</label>
                        <select id="ai-content-subject-select" class="w-full p-3 border border-border-color rounded-lg bg-input-bg text-input-text">
                            <option value="">Select or Add New Subject</option>
                        </select>
                        <input type="text" id="ai-content-new-subject-input" class="w-full mt-2 p-3 border border-border-color rounded-lg text-primary hidden" placeholder="New Subject Name">
                        <button id="toggle-ai-content-new-subject-input" class="text-accent-blue text-sm mt-2 hover:underline">Add New Subject</button>
                    </div>

                    <div class="flex flex-wrap gap-3 mt-6 justify-center sm:justify-start">
                        <button id="generate-ai-notes-btn" class="bg-accent-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-accent-blue-hover transition-all shadow-md">
                            Generate AI Notes
                        </button>
                        <button id="generate-notes-flashcards-btn" class="bg-accent-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-accent-blue-hover transition-all shadow-md">
                            Generate Flashcards
                        </button>
                        <button id="generate-quiz-btn" class="bg-accent-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-accent-blue-hover transition-all shadow-md">
                            Generate Quiz
                        </button>
                        <button id="extract-keywords-btn" class="bg-accent-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-accent-blue-hover transition-all shadow-md">
                            Extract Keywords
                        </button>
                        <button id="predict-exam-questions-btn" class="bg-accent-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-accent-blue-hover transition-all shadow-md">
                            Predict Exam Questions
                        </button>
                        <button id="summarize-content-btn" class="bg-accent-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-accent-blue-hover transition-all shadow-md">
                            Summarize Content
                        </button>
                    </div>
                    <p id="ai-generation-status" class="text-secondary text-sm mt-4 text-center hidden">Processing AI...</p>
                </div>

                <div id="ai-generated-output" class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color hidden">
                    <h3 class="text-xl font-bold text-primary mb-4" id="ai-output-title">Generated Content</h3>
                    <div id="ai-output-content-display" class="space-y-4 text-secondary">
                        <!-- AI generated content will be displayed here -->
                    </div>
                </div>
            </div>

            <div id="view-analytics" class="hidden space-y-8">
                 <div>
                    <h2 class="text-3xl font-bold text-primary">Learning Analytics</h2>
                    <p class="text-secondary mt-1">Visualize your progress, identify trends, and gain deep insights into your study habits and knowledge retention.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                        <h3 class="font-semibold text-primary">Mastery Breakdown</h3>
                        <div class="chart-container mt-4"><canvas id="masteryChart"></canvas></div>
                        <p class="text-secondary text-sm mt-3">Distribution of your knowledge atoms by their current mastery level.</p>
                    </div>
                    <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                        <h3 class="font-semibold text-primary">Study Activity (Last 7 Days)</h3>
                        <div class="chart-container mt-4"><canvas id="activityChart"></canvas></div>
                        <p class="text-secondary text-sm mt-3">Hours spent on active learning, broken down by day.</p>
                    </div>
                </div>
                 <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                    <h3 class="font-semibold text-primary">Knowledge Growth Over Time</h3>
                     <div class="chart-container mt-4"><canvas id="growthChart"></canvas></div>
                     <p class="text-secondary text-sm mt-3">Cumulative total of knowledge atoms you've mastered over the past six months.</p>
                </div>
                <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-primary">Learning Goals</h3>
                        <button id="add-goal-btn" class="bg-accent-blue text-white text-sm font-semibold py-1.5 px-3 rounded-lg hover:bg-accent-blue-hover transition-all shadow-md">
                            + Add Goal
                        </button>
                    </div>
                    <div id="goals-list" class="space-y-4">
                        <p id="empty-goals-message" class="text-secondary text-center hidden">No goals set yet. Click "Add Goal" to create your first objective!</p>
                    </div>
                </div>
            </div>
            
            <div id="view-study" class="hidden">
                 <div class="max-w-3xl mx-auto text-center">
                    <h2 class="text-2xl font-bold text-primary">Study Session</h2>
                    <p class="text-secondary text-sm">AI-Powered Quizzes & Flashcards</p>
                    <p id="study-progress-text" class="text-secondary mt-1">Atom 1 of 15</p>
                    <div class="w-full bg-border-color rounded-full h-2.5 mt-4">
                        <div id="study-progress-bar" class="bg-accent-blue h-2.5 rounded-full" style="width: 7%"></div>
                    </div>
                </div>
                <div class="mt-8 perspective-1000">
                    <div id="flashcard-container" class="flip-card relative w-full max-w-2xl mx-auto h-80">
                        <div id="flashcard-front" class="flip-card-front absolute w-full h-full p-8 rounded-2xl shadow-lg border border-border-color flex flex-col justify-center items-center text-center">
                            <p class="text-xs text-secondary mb-2" id="card-subject-front"></p>
                            <p class="text-xl md:text-2xl font-medium text-primary" id="card-question"></p>
                            <button id="show-answer-btn" class="absolute bottom-6 bg-primary text-white font-semibold py-2 px-6 rounded-lg hover:bg-slate-900 transition-all">Show Answer</button>
                        </div>
                        <div id="flashcard-back" class="flip-card-back absolute w-full h-full p-8 rounded-2xl shadow-lg border border-border-color flex flex-col justify-center items-center text-center">
                            <p class="text-xs text-secondary mb-2" id="card-subject-back"></p>
                            <p class="text-lg font-medium mb-6 text-primary" id="card-answer"></p>
                            <div class="absolute bottom-6 w-full px-6">
                                <p class="text-sm text-secondary mb-3">How well did you recall this?</p>
                                <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                                    <button data-rating="0" class="recall-btn bg-red-100 text-red-700 hover:bg-red-200 p-3 rounded-lg font-semibold transition-all">Forgot</button>
                                    <button data-rating="1" class="recall-btn bg-orange-100 text-orange-700 hover:bg-orange-200 p-3 rounded-lg font-semibold transition-all">Struggled</button>
                                    <button data-rating="2" class="recall-btn bg-yellow-100 text-yellow-700 hover:bg-yellow-200 p-3 rounded-lg font-semibold transition-all">Good</button>
                                    <button data-rating="3" class="recall-btn bg-green-100 text-green-700 hover:bg-green-200 p-3 rounded-lg font-semibold transition-all">Perfect</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-focus" class="hidden space-y-8">
                <div>
                    <h2 class="text-3xl font-bold text-primary">Focus Tools</h2>
                    <p class="text-secondary mt-1">Optimize your environment for deep concentration and effective learning sessions.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                        <h3 class="font-semibold text-primary mb-4">Smart Focus Timer (Pomodoro)</h3>
                        <div class="text-center">
                            <p id="pomodoro-timer" class="text-6xl font-bold text-primary">25:00</p>
                            <p id="pomodoro-status" class="text-secondary mt-2">Time to focus!</p>
                            <div class="flex justify-center gap-4 mt-6">
                                <button id="pomodoro-start" class="bg-accent-blue text-white font-semibold py-2 px-6 rounded-lg hover:bg-accent-blue-hover transition-all">Start</button>
                                <button id="pomodoro-pause" class="bg-border-color text-primary font-semibold py-2 px-6 rounded-lg hover:bg-slate-300 transition-all">Pause</button>
                                <button id="pomodoro-reset" class="bg-red-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-600 transition-all">Reset</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color">
                        <h3 class="font-semibold text-primary mb-4">Ambient Soundscapes</h3>
                        <div id="soundscapes" class="grid grid-cols-2 gap-4"></div>
                    </div>
                </div>
            </div>

            <div id="view-learning-hub" class="hidden space-y-6">
                <div>
                    <h2 class="text-3xl font-bold text-primary">Learning Hub</h2>
                    <p class="text-secondary mt-1">Explore science-backed study techniques, memorization strategies, and understand common cognitive biases to supercharge your learning process.</p>
                </div>
                <div class="flex space-x-4 border-b border-border-color pb-2 overflow-x-auto whitespace-nowrap">
                    <button data-category="auralearnBasics" class="tab-button text-primary font-semibold py-2 px-4 rounded-t-lg hover:bg-border-color">AuraLearn Basics</button>
                    <button data-category="techniques" class="tab-button text-primary font-semibold py-2 px-4 rounded-t-lg bg-accent-blue text-white">Study Techniques</button>
                    <button data-category="memorization" class="tab-button text-primary font-semibold py-2 px-4 rounded-t-lg hover:bg-border-color">Memorization</button>
                    <button data-category="biases" class="tab-button text-primary font-semibold py-2 px-4 rounded-t-lg hover:bg-border-color">Cognitive Biases</button>
                    <button data-category="productivity" class="tab-button text-primary font-semibold py-2 px-4 rounded-t-lg hover:bg-border-color">Productivity & Habits</button>
                    <button data-category="examPrep" class="tab-button text-primary font-semibold py-2 px-4 rounded-t-lg hover:bg-border-color">Exam Prep</button>
                    <button data-category="advanced" class="tab-button text-primary font-semibold py-2 px-4 rounded-t-lg hover:bg-border-color">Advanced Strategies</button>
                </div>
                <div id="learning-hub-content" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <div id="view-settings" class="hidden space-y-6">
                <div>
                    <h2 class="text-3xl font-bold text-primary">Settings</h2>
                    <p class="text-secondary mt-1">Personalize your AuraLearn experience.</p>
                </div>
                <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color space-y-4">
                    <h3 class="text-xl font-bold text-primary">User Profile</h3>
                    <div class="flex items-center gap-4">
                        <label for="username-input" class="text-primary font-semibold">Username:</label>
                        <input type="text" id="username-input" class="flex-grow p-3 border border-border-color rounded-lg" value="User">
                        <button id="save-username-btn" class="bg-accent-blue text-white font-semibold py-2 px-4 rounded-lg hover:bg-accent-blue-hover transition-all">Save</button>
                    </div>
                </div>
                <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color space-y-4">
                    <h3 class="text-xl font-bold text-primary">Themes</h3>
                    <p class="text-secondary">Choose your preferred visual theme for the app.</p>
                    <div class="flex gap-4">
                        <button data-theme="light" class="theme-btn border-2 border-accent-blue p-3 rounded-lg text-primary font-semibold hover:opacity-80 transition-opacity">Light</button>
                        <button data-theme="dark" class="theme-btn border-2 border-border-color p-3 rounded-lg text-primary font-semibold hover:opacity-80 transition-opacity">Dark</button>
                        <button data-theme="vibrant" class="theme-btn border-2 border-border-color p-3 rounded-lg text-primary font-semibold hover:opacity-80 transition-opacity">Vibrant</button>
                    </div>
                </div>
                <div class="bg-secondary p-6 rounded-xl shadow-sm border border-border-color space-y-4">
                    <h3 class="text-xl font-bold text-primary">Spaced Repetition Intervals (Days)</h3>
                    <p class="text-secondary">Customize how often atoms are reviewed based on recall.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="interval-perfect" class="block text-primary text-sm font-semibold mb-2">Perfect Recall:</label>
                            <input type="number" id="interval-perfect" class="w-full p-3 border border-border-color rounded-lg" value="7">
                        </div>
                        <div>
                            <label for="interval-good" class="block text-primary text-sm font-semibold mb-2">Good Recall:</label>
                            <input type="number" id="interval-good" class="w-full p-3 border border-border-color rounded-lg" value="3">
                        </div>
                        <div>
                            <label for="interval-struggled" class="block text-primary text-sm font-semibold mb-2">Struggled Recall:</label>
                            <input type="number" id="interval-struggled" class="w-full p-3 border border-border-color rounded-lg" value="1">
                        </div>
                        <div>
                            <label for="interval-forgot" class="block text-primary text-sm font-semibold mb-2">Forgot Recall:</label>
                            <input type="number" id="interval-forgot" class="w-full p-3 border border-border-color rounded-lg" value="0.5">
                        </div>
                    </div>
                    <button id="save-intervals-btn" class="mt-4 w-full bg-accent-blue text-white font-semibold py-2 rounded-lg hover:bg-accent-blue-hover transition-all">Save Intervals</button>
                </div>
            </div>

            <div id="detail-modal" class="fixed inset-0 hidden modal z-50">
                <div class="bg-secondary p-8 rounded-xl shadow-2xl border border-border-color w-full max-w-2xl mx-auto overflow-y-auto max-h-[90vh]">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary" id="detail-title"></h3>
                        <button id="close-detail-modal" class="text-secondary text-2xl hover:text-primary">&times;</button>
                    </div>
                    <div class="space-y-4 text-secondary" id="detail-content">
                         <div id="detail-content-text"></div>
                         <p id="detail-loading" class="text-center text-accent-blue hidden">Generating detailed explanation...</p>
                    </div>
                </div>
            </div>

            <div id="subject-detail-modal" class="fixed inset-0 hidden modal z-50">
                <div class="bg-secondary p-8 rounded-xl shadow-2xl border border-border-color w-full max-w-2xl mx-auto overflow-y-auto max-h-[90vh]">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary" id="subject-detail-title"></h3>
                        <button id="close-subject-detail-modal" class="text-secondary text-2xl hover:text-primary">&times;</button>
                    </div>
                    <div id="subject-atoms-list" class="space-y-4 text-secondary">
                        <!-- List of atoms for the subject will go here -->
                    </div>
                </div>
            </div>

            <div id="onboarding-modal" class="fixed inset-0 modal z-50">
                <div class="bg-secondary p-8 rounded-xl shadow-2xl border border-border-color w-full max-w-lg mx-auto text-center">
                    <h3 class="text-3xl font-bold text-primary mb-4">Welcome to AuraLearn!</h3>
                    <p class="text-secondary mb-6" id="onboarding-text">Let's set up your personalized learning journey. This quick tour will help AuraLearn understand your goals.</p>
                    <div id="onboarding-steps" class="space-y-4">
                        <div id="step-1">
                            <h4 class="font-semibold text-primary mb-2">What are your primary learning goals?</h4>
                            <textarea id="goal-input" class="w-full h-24 p-3 border border-border-color rounded-lg text-primary" placeholder="E.g., Pass my calculus exam, Learn web development basics, Understand cognitive psychology deeply..."></textarea>
                        </div>
                        <div id="step-2" class="hidden">
                            <h4 class="font-semibold text-primary mb-2">How much time can you dedicate to learning per week?</h4>
                            <input type="number" id="time-input" class="w-full p-3 border border-border-color rounded-lg text-primary" placeholder="Hours per week">
                        </div>
                        <div id="step-3" class="hidden">
                            <h4 class="font-semibold text-primary mb-2">What subjects are you currently focusing on?</h4>
                            <input type="text" id="subjects-input" class="w-full p-3 border border-border-color rounded-lg text-primary" placeholder="Comma-separated, e.g., Math, Science, History">
                        </div>
                    </div>
                    <button id="onboarding-next-btn" class="mt-8 bg-accent-blue text-white font-semibold py-3 px-8 rounded-lg hover:bg-accent-blue-hover transition-all">Next</button>
                    <button id="onboarding-skip-btn" class="mt-4 text-secondary hover:text-primary transition-colors">Skip for now</button>
                </div>
            </div>

            <div id="quick-add-atom-modal" class="fixed inset-0 hidden modal z-50">
                <div class="bg-secondary p-8 rounded-xl shadow-2xl border border-border-color w-full max-w-md mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary">Quick Add Learning Atom</h3>
                        <button id="close-quick-add-modal" class="text-secondary text-2xl hover:text-primary">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="quick-add-subject" class="block text-primary text-sm font-semibold mb-2">Subject:</label>
                            <select id="quick-add-subject" class="w-full p-3 border border-border-color rounded-lg bg-input-bg text-input-text">
                                <option value="">Select or Add New Subject</option>
                            </select>
                            <input type="text" id="new-subject-input" class="w-full mt-2 p-3 border border-border-color rounded-lg text-primary hidden" placeholder="New Subject Name">
                            <button id="toggle-new-subject-input" class="text-accent-blue text-sm mt-2 hover:underline">Add New Subject</button>
                        </div>
                        <div>
                            <label for="quick-add-question" class="block text-primary text-sm font-semibold mb-2">Question/Concept:</label>
                            <textarea id="quick-add-question" class="w-full h-24 p-3 border border-border-color rounded-lg text-primary" placeholder="What is the capital of France?"></textarea>
                        </div>
                        <div>
                            <label for="quick-add-answer" class="block text-primary text-sm font-semibold mb-2">Answer/Explanation:</label>
                            <textarea id="quick-add-answer" class="w-full h-24 p-3 border border-border-color rounded-lg text-primary" placeholder="Paris."></textarea>
                        </div>
                    </div>
                    <button id="add-atom-btn" class="mt-6 w-full bg-accent-blue text-white font-semibold py-3 rounded-lg hover:bg-accent-blue-hover transition-all">
                        Add Atom
                    </button>
                </div>
            </div>

            <div id="add-goal-modal" class="fixed inset-0 hidden modal z-50">
                <div class="bg-secondary p-8 rounded-xl shadow-2xl border border-border-color w-full max-w-md mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary">Add New Learning Goal</h3>
                        <button id="close-add-goal-modal" class="text-secondary text-2xl hover:text-primary">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="goal-name-input" class="block text-primary text-sm font-semibold mb-2">Goal Name:</label>
                            <input type="text" id="goal-name-input" class="w-full p-3 border border-border-color rounded-lg text-primary" placeholder="e.g., Master JavaScript Basics">
                        </div>
                        <div>
                            <label for="goal-target-type" class="block text-primary text-sm font-semibold mb-2">Target Type:</label>
                            <select id="goal-target-type" class="w-full p-3 border border-border-color rounded-lg bg-input-bg text-input-text">
                                <option value="atoms">Master X Atoms</option>
                                <option value="time">Study X Hours</option>
                            </select>
                        </div>
                        <div>
                            <label for="goal-target-value" class="block text-primary text-sm font-semibold mb-2">Target Value:</label>
                            <input type="number" id="goal-target-value" class="w-full p-3 border border-border-color rounded-lg text-primary" placeholder="e.g., 50 or 20">
                        </div>
                        <div>
                            <label for="goal-end-date" class="block text-primary text-sm font-semibold mb-2">End Date:</label>
                            <input type="date" id="goal-end-date" class="w-full p-3 border border-border-color rounded-lg text-primary">
                        </div>
                    </div>
                    <button id="create-goal-btn" class="mt-6 w-full bg-accent-blue text-white font-semibold py-3 rounded-lg hover:bg-accent-blue-hover transition-all">
                        Create Goal
                    </button>
                </div>
            </div>

            <div id="reflection-modal" class="fixed inset-0 hidden modal z-50">
                <div class="bg-secondary p-8 rounded-xl shadow-2xl border border-border-color w-full max-w-md mx-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-primary">Reflect on Your Session</h3>
                        <button id="close-reflection-modal" class="text-secondary text-2xl hover:text-primary">&times;</button>
                    </div>
                    <p class="text-secondary mb-4">What was most challenging or insightful in this study session?</p>
                    <textarea id="reflection-text" class="w-full h-32 p-3 border border-border-color rounded-lg text-primary" placeholder="Type your thoughts here..."></textarea>
                    <button id="save-reflection-btn" class="mt-6 w-full bg-accent-blue text-white font-semibold py-3 rounded-lg hover:bg-accent-blue-hover transition-all">
                        Save Reflection
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Notification Toast Element -->
    <div id="notification-toast" class="hidden"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References (ensure these are correctly captured) ---
            const appContainer = document.getElementById('app-container');
            const themeButtons = document.querySelectorAll('.theme-btn');
            const navLinks = document.querySelectorAll('.nav-item');
            const mobileMenuButton = document.getElementById('menu-button');
            const closeMenuButton = document.getElementById('close-menu-button');
            const mobileSidebarContainer = document.getElementById('mobile-sidebar-container');
            const mobileSidebar = document.getElementById('mobile-sidebar');
            const views = {
                dashboard: document.getElementById('view-dashboard'), library: document.getElementById('view-library'),
                'ai-learning': document.getElementById('view-ai-learning'), // New AI Learning View
                analytics: document.getElementById('view-analytics'), study: document.getElementById('view-study'),
                focus: document.getElementById('view-focus'), 'learning-hub': document.getElementById('view-learning-hub'),
                settings: document.getElementById('view-settings')
            };
            const startReviewBtn = document.getElementById('start-review-btn');
            const showAnswerBtn = document.getElementById('show-answer-btn');
            const flashcardContainer = document.getElementById('flashcard-container');
            const recallButtons = document.querySelectorAll('.recall-btn');
            const dashboardUsername = document.getElementById('dashboard-username');
            const dailyQueueCount = document.getElementById('daily-queue-count');
            const currentStreak = document.getElementById('current-streak');
            const totalMasteredAtoms = document.getElementById('total-mastered-atoms');
            const recommendedAtomsList = document.getElementById('recommended-atoms-list');
            const dailyChallengeText = document.getElementById('daily-challenge-text');
            const dailyChallengeProgress = document.getElementById('daily-challenge-progress');
            const dailyChallengeStatus = document.getElementById('daily-challenge-status');
            const claimChallengeBtn = document.getElementById('claim-challenge-btn');
            const onboardingModal = document.getElementById('onboarding-modal');
            const onboardingNextBtn = document.getElementById('onboarding-next-btn');
            const onboardingSkipBtn = document.getElementById('onboarding-skip-btn');
            const onboardingText = document.getElementById('onboarding-text');
            const onboardingSteps = {
                'step-1': document.getElementById('step-1'), 'step-2': document.getElementById('step-2'), 'step-3': document.getElementById('step-3')
            };
            
            // New AI Learning Section elements
            const aiInputContent = document.getElementById('ai-input-content');
            const aiInputContentLabel = document.getElementById('ai-input-content-label'); // New label for AI content input
            const aiInputModeToggle = document.getElementById('ai-input-mode-toggle'); // New toggle for AI input mode
            const aiContentSubjectSelect = document.getElementById('ai-content-subject-select');
            const aiContentNewSubjectInput = document.getElementById('ai-content-new-subject-input');
            const toggleAIContentNewSubjectInput = document.getElementById('toggle-ai-content-new-subject-input');
            const generateAiNotesBtn = document.getElementById('generate-ai-notes-btn'); // New AI Notes Button
            const generateNotesFlashcardsBtn = document.getElementById('generate-notes-flashcards-btn');
            const generateQuizBtn = document.getElementById('generate-quiz-btn');
            const extractKeywordsBtn = document.getElementById('extract-keywords-btn');
            const predictExamQuestionsBtn = document.getElementById('predict-exam-questions-btn');
            const summarizeContentBtn = document.getElementById('summarize-content-btn'); // New Summarize Content Button
            const aiGenerationStatus = document.getElementById('ai-generation-status');
            const aiGeneratedOutput = document.getElementById('ai-generated-output');
            const aiOutputTitle = document.getElementById('ai-output-title');
            const aiOutputContentDisplay = document.getElementById('ai-output-content-display');

            // FIX: Declare notificationToast variable here so it's accessible globally within this scope
            const notificationToast = document.getElementById('notification-toast');

            const emptyLibraryMessage = document.getElementById('empty-library-message');
            const quickAddAtomBtnDashboard = document.getElementById('quick-add-atom-btn-dashboard');
            const quickAddAtomBtnLibrary = document.getElementById('quick-add-atom-btn-library');
            const quickAddAtomModal = document.getElementById('quick-add-atom-modal');
            const closeQuickAddModalBtn = document.getElementById('close-quick-add-modal');
            const quickAddSubjectSelect = document.getElementById('quick-add-subject');
            const newSubjectInput = document.getElementById('new-subject-input');
            const toggleNewSubjectInputBtn = document.getElementById('toggle-new-subject-input');
            const quickAddQuestionInput = document.getElementById('quick-add-question');
            const quickAddAnswerInput = document.getElementById('quick-add-answer');
            const addAtomBtn = document.getElementById('add-atom-btn');
            const addGoalBtn = document.getElementById('add-goal-btn');
            const addGoalModal = document.getElementById('add-goal-modal');
            const closeAddGoalModalBtn = document.getElementById('close-add-goal-modal');
            const goalNameInput = document.getElementById('goal-name-input');
            const goalTargetTypeSelect = document.getElementById('goal-target-type');
            const goalTargetValueInput = document.getElementById('goal-target-value');
            const goalEndDateInput = document.getElementById('goal-end-date');
            const createGoalBtn = document.getElementById('create-goal-btn');
            const goalsList = document.getElementById('goals-list');
            const emptyGoalsMessage = document.getElementById('empty-goals-message');
            const detailModal = document.getElementById('detail-modal');
            const closeDetailModalBtn = document.getElementById('close-detail-modal');
            const detailTitle = document.getElementById('detail-title');
            const detailContentText = document.getElementById('detail-content-text'); // Renamed for clarity
            const detailLoading = document.getElementById('detail-loading'); // New loading indicator
            const subjectDetailModal = document.getElementById('subject-detail-modal'); // New modal for subject details
            const closeSubjectDetailModalBtn = document.getElementById('close-subject-detail-modal'); // Close button for new modal
            const subjectDetailTitle = document.getElementById('subject-detail-title'); // Title for new modal
            const subjectAtomsList = document.getElementById('subject-atoms-list'); // List of atoms in new modal
            const reflectionModal = document.getElementById('reflection-modal');
            const closeReflectionModalBtn = document.getElementById('close-reflection-modal');
            const reflectionTextarea = document.getElementById('reflection-text');
            const saveReflectionBtn = document.getElementById('save-reflection-btn');
            const usernameInput = document.getElementById('username-input');
            const saveUsernameBtn = document.getElementById('save-username-btn');
            const sidebarUsername = document.getElementById('sidebar-username');
            const sidebarUsernameMobile = document.getElementById('sidebar-username-mobile');
            const globalSearchInput = document.getElementById('global-search-input');
            // Settings Spaced Repetition Intervals
            const intervalPerfectInput = document.getElementById('interval-perfect');
            const intervalGoodInput = document.getElementById('interval-good');
            const intervalStruggledInput = document.getElementById('interval-struggled');
            const intervalForgotInput = document.getElementById('interval-forgot');
            const saveIntervalsBtn = document.getElementById('save-intervals-btn');
            const subjectGrid = document.getElementById('subject-grid'); // Renamed from libraryContentGrid for clarity
            const aiMaterialsList = document.getElementById('ai-materials-list'); // New AI Materials List
            const emptyAiMaterialsMessage = document.getElementById('empty-ai-materials-message'); // New AI Materials empty message


            // --- Theme application function ---
            function applyTheme(theme) {
                if (appContainer) { // Safety check to ensure appContainer exists
                    appContainer.className = `flex h-screen theme-${theme}`;
                }
                themeButtons.forEach(btn => {
                    if (btn.dataset.theme === theme) {
                        btn.classList.add('border-accent-blue');
                        btn.classList.remove('border-border-color');
                    } else {
                        btn.classList.remove('border-accent-blue');
                        btn.classList.add('border-border-color');
                    }
                });
                localStorage.setItem('auralearn_theme', theme);
                // Re-render charts on theme change to update colors
                if (appState.currentView === 'analytics') {
                    renderAnalytics();
                }
            }

            // --- Notification Function ---
            function showNotification(message, isError = false) {
                // Ensure notificationToast is defined before using it
                if (!notificationToast) {
                    console.error("Notification toast element not found!");
                    return;
                }
                notificationToast.textContent = message;
                notificationToast.classList.remove('hidden', 'error');
                if (isError) {
                    notificationToast.classList.add('error');
                }
                notificationToast.classList.add('show');
                setTimeout(() => {
                    notificationToast.classList.remove('show');
                    setTimeout(() => {
                        notificationToast.classList.add('hidden');
                    }, 300); // Allow fade out before hiding
                }, 4000); // Display for 4 seconds
            }


            // --- Initial Data Loading and State Setup ---
            let initialUserData = {
                name: "User",
                streak: 0,
                totalMastered: 0,
                learningGoals: [],
                weeklyStudyTime: 0,
                focusedSubjects: [],
                dailyChallengeProgress: 0,
                lastChallengeDate: null,
                // Default Spaced Repetition Intervals
                srsIntervals: { perfect: 7, good: 3, struggled: 1, forgot: 0.5 }
            };
            let initialLearningAtoms = [];
            let initialSubjects = [];
            let initialAiMaterials = []; // New array for AI-generated notes, quizzes, etc.

            let mockData = {
                user: JSON.parse(localStorage.getItem('auralearn_user')) || JSON.parse(JSON.stringify(initialUserData)),
                subjects: JSON.parse(localStorage.getItem('auralearn_subjects')) || JSON.parse(JSON.stringify(initialSubjects)),
                learningAtoms: (JSON.parse(localStorage.getItem('auralearn_atoms')) || initialLearningAtoms).map(a => ({
                    ...a,
                    lastReviewed: a.lastReviewed ? new Date(a.lastReviewed) : new Date(), // Robust date parsing
                    nextReview: a.nextReview ? new Date(a.nextReview) : new Date() // Robust date parsing
                })),
                aiMaterials: (JSON.parse(localStorage.getItem('auralearn_ai_materials')) || initialAiMaterials), // New storage for AI materials
                soundscapes: [
                    { name: 'Rain', icon: 'üåßÔ∏è', file: 'rain.mp3' }, { name: 'Forest', icon: 'üå≤', file: 'forest.mp3' },
                    { name: 'Cafe', icon: '‚òï', file: 'cafe.mp3' }, { name: 'Waves', icon: 'üåä', file: 'waves.mp3' }
                ],
                // Updated Learning Hub Content with LLM-expandable details
                learningHubContent: {
                    auralearnBasics: [
                        { title: "What are Learning Atoms?", summary: "The building blocks of your knowledge in AuraLearn.", details: "In AuraLearn, a 'Learning Atom' is the smallest, most fundamental piece of information or concept you want to master. Breaking down knowledge into these atomic units allows AuraLearn's intelligent Spaced Repetition System (SRS) to precisely track your mastery of each individual piece and schedule it for optimal review, ensuring you don't waste time on what you already know while reinforcing challenging concepts." },
                        { title: "How Spaced Repetition Works", summary: "A science-backed method for long-term memory.", details: "AuraLearn's core is its Spaced Repetition System (SRS). After you review a 'Learning Atom', you rate how well you recalled it. Based on your rating, AuraLearn's algorithm calculates the optimal time to show you that atom again ‚Äì just before you're likely to forget it. Easy concepts are reviewed less often, difficult ones more frequently. This adaptive scheduling is scientifically proven to move information from short-term to long-term memory much more efficiently than traditional cramming." },
                        { title: "Your Mastery Score", summary: "Understanding your progress.", details: "Your 'Mastery Score' in AuraLearn reflects how deeply ingrained a 'Learning Atom' is in your long-term memory. It's dynamically updated based on your recall performance during study sessions. The higher your mastery, the less frequently an atom needs to be reviewed. This metric provides a clear, objective view of your knowledge retention over time across all your subjects." }
                    ],
                    techniques: [
                        { title: "Spaced Repetition", summary: "Reviewing material at increasing intervals to optimize retention.", details: "This technique is a cornerstone of effective learning. It leverages the 'spacing effect,' which demonstrates that learning is more effective when study sessions are spaced out over time rather than crammed into a single session. AuraLearn's algorithm dynamically adjusts the review intervals for each 'learning atom' based on your recall performance. If you recall an atom easily, it's scheduled further into the future (e.g., 7 days); if you struggle, it comes back sooner (e.g., 1 day or even hours). This adaptive scheduling ensures you revisit information just as you're about to forget it, significantly enhancing long-term memory consolidation and reducing study time on already mastered concepts." },
                        { title: "Active Recall", summary: "Testing yourself rather than passively re-reading.", details: "Active recall, also known as 'retrieval practice,' is a powerful study technique that involves actively pulling information from your memory rather than passively rereading notes or textbooks. When you practice active recall (e.g., through flashcards, self-quizzing, or explaining concepts aloud), you strengthen the neural pathways associated with that information, making it easier to retrieve in the future. This effortful retrieval process is much more effective for long-term retention than simply reviewing material. AuraLearn's flashcard system and 'Explain Concept' AI feature are designed to facilitate active recall, transforming passive study into active, effective learning." },
                        { title: "Feynman Technique", summary: "Learn by teaching; simplify complex ideas.", details: "The Feynman Technique, named after Nobel laureate physicist Richard Feynman, is a method for deeply understanding concepts by attempting to explain them in simple terms. The process involves four steps: 1) Choose a concept and study it, 2) Explain it as if to a child, 3) Identify gaps in your explanation and go back to the source material, and 4) Organize and simplify your explanation until it's clear and concise. This technique forces you to identify areas where your understanding is superficial, encourages simplification, and solidifies your knowledge by making connections. It's highly practical for moving from memorization to true comprehension." },
                        { title: "Interleaving", summary: "Mixing different topics/problems during study.", details: "Interleaving is a study strategy where you mix different types of problems or topics within a single study session, rather than 'blocking' (studying one topic exhaustively before moving to the next). For example, instead of practicing 20 algebra problems, then 20 geometry problems, you would mix them up. While initially it might feel harder because it requires your brain to constantly switch contexts, research shows interleaving leads to stronger long-term retention and better transfer of knowledge to new situations. It helps you discriminate between different concepts and choose the correct strategy for each problem type." },
                        { title: "Elaboration", summary: "Connecting new info to existing knowledge.", details: "Elaboration is a powerful memory encoding strategy that involves actively trying to connect new information with what you already know, or by creating a deeper understanding of the new material. This can involve asking 'why?' or 'how?' questions about the material, thinking of real-world examples, creating analogies, or finding personal relevance. By building a richer and more interconnected web of knowledge, you create more retrieval pathways, making the information easier to recall and less likely to be forgotten. It turns rote memorization into meaningful learning." },
                        { title: "Retrieval Practice", summary: "Actively pulling information out of your brain.", details: "Retrieval practice is the act of recalling learned information from memory. This is not just a way to assess knowledge, but a powerful learning strategy in itself. Every time you successfully retrieve a piece of information, the memory trace for that information becomes stronger and more stable. This means that activities like self-quizzing, using flashcards, writing summaries from memory, or attempting practice problems without looking at notes are incredibly effective. It's about effortful recall, which solidifies learning more than passive re-reading or highlighting." },
                        { title: "Reading & Understanding Fast", summary: "Strategies to accelerate comprehension without losing depth.", details: "Efficient reading isn't just about speed; it's about accelerating comprehension without sacrificing depth. Key strategies include: 1) **Previewing:** Skim the title, headings, introduction, and conclusion to get a general idea. 2) **Questioning:** Formulate questions before and during reading. 3) **Active Engagement:** Highlight key points, take concise notes, and summarize sections in your own words. 4) **Chunking:** Read in phrases rather than word-by-word. 5) **Minimizing Subvocalization:** Try to reduce mentally 'saying' words as you read. These practices help you extract the most important information quickly and improve overall understanding." },
                        { title: "Study Effectively", summary: "Optimizing your study time for maximum impact.", details: "Studying effectively is about maximizing the quality, not just the quantity, of your study time. Practical strategies include: 1) **Set Clear Goals:** Define what you want to achieve in each session. 2) **Active Learning:** Prioritize active recall, spaced repetition, and problem-solving over passive methods. 3) **Minimize Distractions:** Create a dedicated study environment free from interruptions. 4) **Take Strategic Breaks:** Use methods like Pomodoro (25 min work, 5 min break) to maintain focus and prevent burnout. 5) **Self-Assessment:** Regularly test yourself to identify knowledge gaps. 6) **Vary Study Methods:** Mix techniques to keep engagement high. These habits build consistent, high-impact learning."}
                    ],
                    memorization: [
                        { title: "Mnemonic Devices", summary: "Using memory aids like acronyms or rhymes.", details: "Mnemonic devices are techniques that act as memory aids, helping you recall information that might otherwise be difficult to remember. They work by creating a vivid and often unusual connection between the new information and something you already know. Common types include: 1) **Acronyms:** Using the first letter of each word to form a new word (e.g., 'ROY G BIV' for the colors of the rainbow). 2) **Acrostics:** Creating a sentence where the first letter of each word represents an item to be remembered (e.g., 'My Very Educated Mother Just Served Us Noodles' for planets). 3) **Rhymes & Songs:** Setting information to a catchy tune or rhyme. 4) **Visual Imagery:** Creating a bizarre mental picture involving the items. These techniques provide strong retrieval cues for complex information." },
                        { title: "Method of Loci (Memory Palace)", summary: "Associating items with locations in a familiar place.", details: "The Method of Loci, or 'Memory Palace,' is an ancient memorization technique that leverages our strong spatial memory. You associate items you want to remember with specific locations along a familiar mental 'journey' or within a well-known building (your 'palace'). To recall the information, you mentally 'walk' through your palace, encountering the items in their assigned locations. The more vivid and interactive your mental images are, the more effective this method becomes. It's particularly useful for remembering lists, sequences, or speeches, as it transforms abstract information into a concrete, navigable mental landscape." },
                        { title: "Chunking", summary: "Grouping information into smaller, manageable units.", details: "Chunking is a cognitive strategy that involves organizing individual pieces of information into larger, more meaningful units or 'chunks.' Our working memory has a limited capacity (roughly 7 +/- 2 items). By grouping related items into a single chunk, you effectively expand this capacity. For example, remembering a 10-digit phone number as three chunks (e.g., 555-123-4567) is easier than remembering 10 individual digits. This technique is highly practical for memorizing long numbers, lists, or even complex concepts by breaking them down into digestible, interconnected components." },
                        { title: "Visual Imagery", summary: "Creating vivid mental pictures to aid recall.", details: "Visual imagery for memorization involves forming strong, vivid mental pictures of the information you want to remember. The human brain is highly adept at processing visual information. The more bizarre, exaggerated, humorous, or interactive the mental image you create, the more memorable it becomes. This technique is especially effective for concrete nouns, but it can also be applied to abstract concepts by translating them into visual metaphors. For instance, picturing a specific historical event unfolding like a movie scene can embed it more firmly in your memory than simply reading about it." },
                        { title: "Story Method", summary: "Weaving items into a narrative.", details: "The Story Method, or 'chaining,' is a mnemonic technique where you connect items you need to remember by creating a narrative or story that links them together. The story doesn't necessarily need to be logical or make perfect sense; in fact, often the more imaginative, unusual, or humorous the story, the easier it is to recall the sequence of items. Each item in your list becomes a 'character' or 'event' in your mental narrative. This method is particularly useful for remembering lists in a specific order, as the flow of the story provides a natural retrieval cue." },
                        { title: "Remember What You Read", summary: "Strategies to retain information from texts.", details: "To effectively remember what you read, passive consumption isn't enough. Employ active reading techniques: 1) **SQ3R Method:** Survey, Question, Read, Recite, Review. 2) **Highlight & Annotate:** But do so selectively; don't just highlight everything. Add your own thoughts and questions in the margins. 3) **Take Summary Notes:** After each section, close the book and write down the main ideas in your own words. 4) **Active Recall:** Periodically quiz yourself on what you've just read. 5) **Connect to Prior Knowledge:** Relate new information to what you already know to create stronger memory links. These strategies transform reading into an active learning process." },
                        { title: "Memorize Fast", summary: "Accelerated memorization techniques.", details: "To memorize quickly and effectively for long-term retention, combine multiple powerful techniques: 1) **Understand First:** Don't try to memorize what you don't understand. Deep comprehension makes memorization easier. 2) **Spaced Repetition:** Use tools like AuraLearn to schedule optimal review times. 3) **Active Recall:** Constantly test yourself. 4) **Chunking:** Break information into smaller, digestible units. 5) **Mnemonic Devices:** Employ acronyms, visual imagery, or the Method of Loci for complex lists. 6) **Teach Others:** Explaining a concept solidifies your own understanding and exposes gaps. Focus on these active, scientifically-backed methods rather than passive cramming."}
                    ],
                    biases: [
                        { title: "Confirmation Bias", summary: "Seeking info that confirms existing beliefs.", details: "Confirmation bias is the tendency to seek out, interpret, and favor information that confirms your existing beliefs or hypotheses, while disproportionately ignoring or downplaying evidence that contradicts them. In the context of learning, this can be detrimental because it prevents objective evaluation of new information. For example, if you believe a certain study method is best, you might only notice successes and dismiss failures. To combat this, actively seek out diverse perspectives, consider alternative explanations, and specifically look for evidence that challenges your current understanding. AuraLearn's reflection tools can prompt you to consider different viewpoints." },
                        { title: "Availability Heuristic", summary: "Overestimating based on ease of recall.", details: "The Availability Heuristic is a mental shortcut where we estimate the likelihood or frequency of an event based on how easily examples or instances come to mind. If something is easily recalled (e.g., due to recent exposure, vividness, or emotional impact), we tend to overestimate its prevalence. In learning, this might lead you to believe you understand a topic thoroughly because the most common examples are at the tip of your tongue, even if you lack a deeper, comprehensive grasp. To mitigate this, intentionally seek out less obvious or more challenging examples, and rely on systematic review rather than just what feels familiar." },
                        { title: "Dunning-Kruger Effect", summary: "Mistakenly overestimating one's knowledge/ability.", details: "The Dunning-Kruger Effect is a cognitive bias in which people with low ability at a task overestimate their own ability, while those with high ability tend to underestimate their competence. In learning, this means novices might falsely believe they've mastered a subject after a superficial review, leading to insufficient study. Conversely, true experts might assume a task is easy for everyone, underestimating the effort required. AuraLearn's objective mastery tracking and spaced repetition system aim to provide concrete, unbiased feedback on your true knowledge gaps, helping you allocate study time effectively and overcome both overconfidence and undue self-doubt." },
                        { title: "Anchoring Bias", summary: "Over-relying on the first piece of info encountered.", details: "Anchoring bias is the tendency to rely too heavily on the first piece of information offered (the 'anchor') when making decisions or judgments. Subsequent information is then interpreted relative to this initial anchor. In learning, an initial incorrect or limited understanding of a concept can become an 'anchor,' making it difficult to adjust your understanding later, even when presented with more accurate information. For instance, if you first learn a simplified version of a complex theory, that simplification might 'anchor' your understanding, hindering you from grasping its full nuances later. Be aware of your initial impressions and be willing to actively challenge and adjust them as new information comes in." },
                        { title: "Hindsight Bias", summary: "'I knew it all along' phenomenon.", details: "Hindsight bias, often called the 'I-knew-it-all-along' effect, is the inclination, after an event has occurred, to see the event as having been predictable, despite there having been little or no objective basis for predicting it beforehand. This bias can impede effective learning from past mistakes because you falsely believe you already understood the outcome or the solution, reducing the perceived need for deeper analysis or corrective action. To combat this, actively record your predictions *before* an event or problem is solved, and compare them with the actual outcomes to realistically assess your initial knowledge and identify true learning opportunities." }
                    ],
                    productivity: [
                        { title: "The 1-Hour Study Method", summary: "Structured, efficient study blocks.", details: "The 1-Hour Study Method is a structured time management technique designed to maximize focus and productivity. It involves dedicating **50 minutes to intense, uninterrupted, focused study**, immediately followed by a **10-minute break**. This method is similar to the Pomodoro Technique but allows for a slightly longer period of deep work, which can be beneficial for complex subjects requiring more sustained concentration. The short, scheduled breaks help prevent mental fatigue, improve retention, and keep you refreshed. It trains your brain to concentrate for set periods, making your study sessions much more efficient than unstructured, lengthy sessions prone to distraction." },
                        { title: "Love Disciplining Yourself", summary: "Strategies for building self-discipline.", details: "Building self-discipline for learning isn't about harshness, but about consistent, small actions that build momentum. Key strategies include: 1) **Set Clear Micro-Goals:** Break large goals into tiny, achievable daily tasks. 2) **Establish Routines:** Consistently study at the same time and place to create strong habits. 3) **Eliminate Distractions:** Design your environment to make studying easier and distractions harder (e.g., put phone away). 4) **Practice Delayed Gratification:** Resist immediate temptations for long-term rewards. 5) **Reward Small Wins:** Acknowledge your efforts and progress to reinforce positive behavior. 6) **Understand Your 'Why':** Connect your discipline to your overarching learning goals and purpose. Discipline is a muscle that strengthens with consistent exercise." },
                        { title: "Stop Phone Addiction", summary: "Practical steps to reduce digital distractions.", details: "Phone addiction severely impacts focus and learning. To combat it effectively: 1) **Set App Limits:** Use your phone's built-in features to limit time on distracting apps. 2) **Use 'Do Not Disturb' Modes:** Silence notifications during study blocks. 3) **Physical Separation:** Keep your phone in another room or out of sight during focused work. 4) **Scheduled Checks:** Designate specific times to check messages/social media. 5) **Find Alternatives:** Replace phone-checking habits with productive or relaxing break activities (e.g., light stretching, reading a physical book). 6) **Awareness:** Track your usage to understand triggers. Gradually reducing reliance helps regain focus and control over your attention." },
                        { title: "6-Step Method for Catching Up", summary: "A structured approach to recover lost study time.", details: "When you fall behind, a structured approach is crucial to avoid overwhelm: 1) **Prioritize ruthlessly:** Identify the most critical topics or exams that need immediate attention. 2) **Break it down:** Divide the daunting backlog into very small, manageable chunks. 3) **Schedule dedicated blocks:** Allocate specific, uninterrupted time slots in your calendar just for catch-up work. 4) **Focus on active recall:** Use self-quizzing, flashcards, or practice problems to maximize efficiency. 5) **Leverage summaries:** If time is extremely short, focus on summaries, key concepts, and past exam questions rather than re-reading entire chapters. 6) **Seek help strategically:** Don't hesitate to ask specific questions from teachers or peers for clarity on difficult points. Avoid the urge to cram everything; focus on high-impact learning." },
                        { title: "Use Second Brain", summary: "Organizing your knowledge outside your head.", details: "A 'Second Brain' is a digital system for organizing all your notes, ideas, and learning resources, essentially serving as an extension of your own memory. Tools like Notion, Evernote, or Obsidian allow you to: 1) **Capture:** Quickly save anything interesting or important you encounter. 2) **Organize:** Structure your notes by projects, areas of interest, resources, and archives. 3) **Distill:** Summarize and highlight key information. 4) **Express:** Use your organized knowledge to create, write, and learn more effectively. This system frees up your mental RAM, reduces cognitive load, and allows you to connect disparate ideas, fostering deeper learning and creativity." },
                        { title: "5 Productivity Tips Teachers Never Teach", summary: "Unconventional but effective study habits.", details: "Beyond traditional advice, these tips can supercharge your productivity: 1) **Teach What You Learn:** Explaining a concept to someone else (or even an imaginary audience) exposes gaps in your understanding and solidifies knowledge. 2) **Strategic Breaks:** Go beyond just short breaks; take walks in nature, engage in light exercise, or meditate to refresh your mind. 3) **Change Your Study Environment:** Shifting locations can improve memory retention due to context-dependent learning. 4) **Use Background Music (Carefully):** Instrumental music, especially classical or lo-fi beats, can enhance focus for some, but lyrics can distract. 5) **Know Your Peak Performance Times:** Identify when you are most alert and focused, and schedule your most challenging tasks for those times. Experiment to discover what truly works for your unique learning style." },
                        { title: "Manage Your Study Schedule", summary: "Creating and sticking to an effective learning routine.", details: "An effective study schedule is a roadmap to consistent progress. Practical steps: 1) **Assess Your Time:** Honestly evaluate how much time you *actually* have. 2) **Prioritize:** List subjects/tasks by importance and urgency. 3) **Allocate Time:** Assign specific blocks for each subject, including review and break times. Be realistic. 4) **Be Specific:** Instead of 'Study Math,' write 'Complete Ch 3 problems 1-10.' 5) **Build Flexibility:** Don't overschedule; leave buffer time for unexpected events. 6) **Review & Adapt:** Weekly, review your progress and adjust your schedule based on what worked and what didn't. Consistency in following a well-planned schedule is far more important than a perfect, but unrealistic, one." },
                        { title: "Best Study Schedules for YOU!", summary: "Tailoring study plans to individual needs.", details: "There's no one-size-fits-all study schedule. The best one is tailored to *your* unique energy levels, commitments, and learning style. Consider: 1) **Chronotype:** Are you a morning lark or a night owl? Schedule your hardest tasks when you're most alert. 2) **Commitments:** Factor in classes, work, and personal obligations. 3) **Learning Style:** Do you prefer short, intense bursts (like Pomodoro) or longer, deep-dive sessions? 4) **Subject Needs:** Some subjects might require more frequent, shorter sessions, while others benefit from longer, focused blocks. Experiment with different structures (e.g., block scheduling, interleaved scheduling) and adjust until you find a rhythm that maximizes your focus, retention, and well-being. Flexibility and self-awareness are key." },
                        { title: "Combat ADHD (Study Tips)", summary: "Strategies for studying with attention challenges.", details: "For individuals with ADHD, effective study strategies are crucial for maintaining focus and maximizing learning: 1) **Break Tasks into Micro-Chunks:** Instead of 'write essay,' think 'outline essay,' 'write intro paragraph,' etc. 2) **Use Visual Aids & Timers:** Visual timers can help manage time and transition. 3) **Incorporate Movement:** Fidgeting or short bursts of exercise can help release restless energy. 4) **Create a Distraction-Free Zone:** Minimize visual and auditory clutter; consider noise-cancelling headphones. 5) **Externalize Information:** Don't rely solely on memory; use notes, checklists, and reminders. 6) **Regular Breaks & Rewards:** Short, frequent breaks prevent burnout, and small rewards can boost motivation. 7) **Medication/Therapy:** These can be powerful tools when combined with behavioral strategies. Focus on structured, engaging, and multi-sensory approaches." },
                        { title: "5 Most Effective Note-Taking Methods", summary: "Optimizing your notes for better retention and recall.", details: "Effective note-taking transforms passive listening into active learning. Here are 5 highly effective methods: 1) **Cornell Notes:** Divide your paper into sections for main notes, cues, and a summary. Promotes active recall. 2) **Sketchnoting:** Combines drawings, symbols, and text to represent ideas visually. Enhances engagement and memory. 3) **Mind Mapping:** Branching diagrams connect central ideas to sub-ideas, showing relationships. Great for brainstorming and complex topics. 4) **Linear Note-Taking:** Traditional bullet points, but with careful use of headings and subheadings. Good for structured information. 5) **Outlining Method:** Uses Roman numerals, letters, and numbers to organize notes hierarchically. Excellent for highly structured lectures or texts. Choose the method that best suits the content and your learning style, or combine elements from different methods." },
                        { title: "5 Effective Study Methods to Boost Motivation", summary: "Techniques to stay engaged and energized.", details: "Maintaining study motivation can be challenging. Here are 5 effective methods: 1) **Set Small, Achievable Goals:** Instead of 'study for 3 hours,' aim for 'complete this section.' Success builds confidence. 2) **Reward Yourself:** Plan small, immediate rewards for completing tasks (e.g., a short break, a favorite snack). 3) **Find a Study Buddy/Group:** Accountability and collaborative learning can boost morale. 4) **Understand Your 'Why':** Connect your current study efforts to your long-term aspirations. Remind yourself of the bigger picture. 5) **Practice Positive Self-Talk:** Challenge negative thoughts; focus on your progress and capabilities. Remember, motivation isn't constant; it's something you actively cultivate." },
                        { title: "Understand Better and Faster", summary: "Deepening comprehension with efficient techniques.", details: "To understand concepts better and faster, move beyond superficial engagement: 1) **Pre-Read/Scan:** Get a general idea before diving deep. 2) **Ask Questions:** Formulate 'why' and 'how' questions as you read/listen. 3) **Explain Aloud:** Articulate the concept in your own words, as if teaching someone. This quickly reveals gaps. 4) **Connect Ideas:** Actively link new information to what you already know. Use analogies. 5) **Summarize Actively:** After a section, summarize it from memory. 6) **Seek Clarification:** Don't let confusion linger; ask questions. These active strategies force deeper processing and lead to more robust, lasting understanding." },
                        { title: "Focus When Feeling Tired", summary: "Tips for maintaining concentration when fatigued.", details: "Studying effectively when tired requires smart strategies: 1) **Short Power Naps:** A 10-20 minute nap can significantly boost alertness. 2) **Hydration & Nutrition:** Drink water and have a healthy snack. 3) **Light Physical Activity:** A quick walk or stretch can increase blood flow and energy. 4) **Change Tasks/Environment:** Switch to a less demanding task or move to a different study spot. 5) **Use Ambient Sounds:** Gentle background noise can sometimes help block out other distractions. 6) **Prioritize Sleep:** These are temporary fixes; consistent, adequate sleep is the ultimate foundation for sustained focus. If truly exhausted, prioritize rest over ineffective study." },
                        { title: "5 Scientifically-Backed Study Methods to Build Discipline", summary: "Practical strategies for fostering self-control in learning.", details: "Building study discipline is about creating strong habits reinforced by science: 1) **Habit Stacking:** Attach a new study habit to an existing one (e.g., 'After I brush my teeth, I will review flashcards for 10 minutes'). 2) **Environmental Design:** Make your study environment conducive to focus and remove temptations (e.g., phone in another room). 3) **If-Then Plans:** Decide in advance how you'll handle common distractions or procrastination triggers ('If I feel like checking social media, then I will immediately do 5 push-ups'). 4) **Accountability Partners:** A study buddy or mentor can provide external motivation and structure. 5) **Progress Tracking:** Visually track your consistent study sessions (e.g., on a calendar or in AuraLearn's analytics) to see your progress and reinforce the habit loop. These methods leverage behavioral psychology to make discipline easier and more automatic." }
                    ],
                    examPrep: [
                        { title: "How to Predict Exam Questions", summary: "Strategies to anticipate potential test content.", details: "Predicting exam questions is about strategic preparation: 1) **Analyze Past Exams:** Look for recurring themes, question formats, and highly tested concepts. 2) **Instructor Clues:** Pay close attention to topics emphasized repeatedly in lectures, readings, or homework assignments. What does your teacher say is 'important'? 3) **Review Learning Objectives/Syllabus:** These often directly state what you're expected to know. 4) **Transform Headings into Questions:** Convert chapter/section headings into questions you can answer. 5) **Practice Problem Patterns:** Understand the *types* of problems rather than just memorizing solutions. 6) **Connect Concepts:** Exam questions often test your ability to link different parts of the material. AuraLearn's AI prediction feature can further assist by generating potential questions based on your input." },
                        { title: "A+ Study Tips Students Won't Tell", summary: "Insider tips for achieving top grades.", details: "Beyond the obvious, these 'secret' A+ study tips focus on deep learning and efficiency: 1) **Active Recall from Day One:** Don't just re-read; test yourself continuously. 2) **Teach to Learn:** Explain concepts to friends, family, or even pets. If you can teach it, you understand it. 3) **Explain Aloud:** Verbally articulating concepts forces coherent understanding. 4) **Vary Study Environments:** Studying in different locations can create more retrieval cues. 5) **Focus on Weaknesses:** Don't just review what you know; identify and actively target your knowledge gaps. 6) **Strategic Breaks & Rewards:** Use short, refreshing breaks and small rewards to maintain motivation and prevent burnout. These methods prioritize quality and active engagement." },
                        { title: "Ace Your Science Exams", summary: "Specific strategies for excelling in science subjects.", details: "Acing science exams requires a specific approach: 1) **Understand Principles:** Don't just memorize facts; grasp the 'why' behind phenomena. 2) **Practice Problem-Solving Relentlessly:** Science is applied knowledge. Work through all practice problems available. 3) **Draw Diagrams & Visuals:** Illustrate processes, structures, and relationships. Label everything. 4) **Review Labs/Experiments:** Understand the methodology, results, and conclusions of any practical work. 5) **Concept Maps:** Create visual maps to connect disparate ideas and see the 'big picture.' 6) **Consistent Review:** Science builds incrementally; regular spaced repetition is vital. Focus on active application of knowledge." },
                        { title: "Study Less and Get Higher Grades", summary: "Efficiency strategies for academic success.", details: "This isn't about laziness; it's about smart, high-leverage studying. Strategies include: 1) **Prioritize High-Yield Topics:** Focus on concepts most likely to appear on exams or those fundamental to understanding the subject. 2) **Active Learning Over Passive:** Spend more time quizzing yourself, teaching, and problem-solving, and less time re-reading. 3) **Spaced Repetition:** Let AuraLearn's algorithm optimize your review schedule so you don't overstudy. 4) **Pre-reading:** Skim material before lectures to get context. 5) **Effective Note-Taking:** Use methods that encourage active processing (e.g., Cornell, mind maps). 6) **Quality Over Quantity:** A focused 30-minute session using active recall is more effective than 2 hours of distracted passive reading. It's about working smarter, not harder." },
                        { title: "Ace Exams in Just 3 Days", summary: "High-intensity, focused exam preparation.", details: "While not ideal for deep retention, this is a crisis strategy for urgent exam prep: 1) **Triage Content:** Ruthlessly prioritize. Focus only on the absolute most important topics based on syllabus, past exams, and instructor cues. 2) **Active Recall ONLY:** No passive reading. Use flashcards, rapid self-quizzing, and practice problems immediately. 3) **Timed Practice:** Do full-length practice exams under strict time limits to build stamina and identify weak spots. 4) **Summarize Key Concepts:** Quickly write down everything you remember about crucial topics. 5) **Prioritize Sleep:** Even during crunch time, some sleep is better than none for cognitive function. This method is about maximizing short-term retrieval, but long-term mastery still requires spaced, consistent effort." },
                        { title: "Decode Exam Questions Like a Pro", summary: "Understanding what questions are truly asking.", details: "Mastering exam questions goes beyond knowing the content; it's about understanding the question itself: 1) **Read Carefully, Twice:** Don't skim. Identify all keywords and constraints. 2) **Identify Command Words:** Words like 'compare,' 'contrast,' 'analyze,' 'explain,' 'evaluate,' 'describe,' 'define,' tell you *what* to do. 3) **Break Down Complex Questions:** If a question has multiple parts, deconstruct it into individual components. 4) **Rephrase in Your Own Words:** If unsure, rephrase the question simply to ensure you grasp its core meaning. 5) **Outline Your Answer:** Before writing, mentally (or physically) outline the key points you'll include, ensuring you address all parts of the prompt. This systematic approach prevents 'answer-what-you-know' instead of 'answer-what-is-asked'." }
                    ],
                    advanced: [
                        { title: "Metacognition & Self-Regulation", summary: "Understanding and managing your own learning.", details: "Metacognition is 'thinking about thinking' ‚Äì your awareness and understanding of your own thought processes. Self-regulation in learning is the ability to actively manage and direct your learning process. This involves: 1) **Planning:** Setting goals and choosing strategies. 2) **Monitoring:** Checking your comprehension and progress during learning. 3) **Evaluating:** Assessing the effectiveness of your strategies and your overall learning outcome. 4) **Adapting:** Adjusting your approach based on what you've learned from monitoring and evaluating. AuraLearn encourages metacognition through features like reflection prompts and detailed analytics, empowering you to become a more independent, strategic, and ultimately more effective learner." },
                        { title: "Dual Coding Theory", summary: "Combining verbal and visual representations.", details: "Dual Coding Theory, proposed by Allan Paivio, suggests that information is processed and stored in memory through two distinct channels: one for verbal information (words, text) and another for non-verbal information (images, diagrams, sounds). Learning is significantly enhanced when both channels are engaged simultaneously. For example, when you read about a concept (verbal) and also visualize it or look at a diagram (non-verbal), you create two separate mental representations. This dual encoding makes the information more robust in memory and increases the likelihood of successful retrieval. Practical applications include using diagrams, illustrations, mind maps, or creating mental images while reading or listening." },
                        { title: "Desirable Difficulties", summary: "Strategies that slow learning but aid long-term retention.", details: "Desirable difficulties are learning conditions that, while initially seeming to make learning harder or slower, actually lead to better long-term retention and transfer of knowledge. Examples include: 1) **Spaced Repetition:** Spreading out study sessions over time instead of cramming. 2) **Active Recall:** Testing yourself rather than just re-reading. 3) **Interleaving:** Mixing different types of problems or topics. 4) **Varied Practice:** Practicing skills in different contexts. These strategies introduce a beneficial 'struggle' that forces deeper cognitive processing and strengthens memory traces, making the learning more robust and flexible for future application. Embrace the effort, as it often signifies more effective learning." },
                        { title: "Growth Mindset", summary: "Believing intelligence can be developed.", details: "A Growth Mindset, a concept developed by Carol Dweck, is the belief that your basic abilities, intelligence, and talents can be developed through dedication and hard work. In contrast to a Fixed Mindset (belief that abilities are static), a growth mindset sees challenges as opportunities for growth, effort as a path to mastery, and mistakes as learning experiences. Embracing this mindset leads to greater persistence in the face of setbacks, a love of learning, and a stronger drive to improve. For learners, cultivating a growth mindset means focusing on the process of learning, celebrating effort, and seeing failures not as an end, but as valuable feedback for improvement." },
                        { title: "Pomodoro Technique", summary: "Structured time management for focus.", details: "The Pomodoro Technique is a time management method developed by Francesco Cirillo. It uses a timer to break down work into intervals, traditionally 25 minutes in length, separated by short breaks. Each interval is known as a 'pomodoro'. The steps are: 1) Choose a task. 2) Set a timer for 25 minutes. 3) Work on the task until the timer rings. 4) Take a 5-minute short break. 5) After four pomodoros, take a longer break (15-30 minutes). This technique helps improve focus, prevents burnout, and fosters a sense of urgency. It teaches your brain to concentrate for fixed periods and provides regular opportunities to rest and recharge, making long study sessions more manageable and effective." }
                    ]
                }
            };
            let appState = {
                currentView: localStorage.getItem('auralearn_currentView') || 'dashboard',
                studySession: { isActive: false, queue: [], currentIndex: 0, atomsReviewedInSession: 0 },
                pomodoro: { timerId: null, timeLeft: 25 * 60, isRunning: false, mode: 'work' },
                onboardingCompleted: localStorage.getItem('auralearn_onboardingCompleted') === 'true',
                currentTheme: localStorage.getItem('auralearn_theme') || 'light',
                learningHubCategory: 'auralearnBasics',
                aiInputMode: 'text' // New state for AI input mode: 'text' or 'topic'
            };

            // Gemini API configuration
            const apiKey = ""; // Canvas will automatically provide this in runtime.

            // Function to calculate next review date based on difficulty
            function calculateNextReviewDate(lastReviewed, difficultyRating) {
                const day = 24 * 60 * 60 * 1000; // milliseconds in a day
                const intervals = mockData.user.srsIntervals; // Use user-defined intervals
                let interval;
                if (difficultyRating === 3) { // Perfect
                    interval = intervals.perfect * day;
                } else if (difficultyRating === 2) { // Good
                    interval = intervals.good * day;
                } else if (difficultyRating === 1) { // Struggled
                    interval = intervals.struggled * day;
                } else { // Forgot (difficultyRating is 0)
                    interval = intervals.forgot * day;
                }
                const nextDate = new Date(lastReviewed.getTime() + interval);
                return nextDate;
            }

            // Get atoms due for review today, sorted by next review date
            function getDailyQueue() {
                const now = new Date();
                return mockData.learningAtoms.filter(atom => {
                    const nextReviewDate = atom.nextReview instanceof Date ? atom.nextReview : new Date(atom.nextReview);
                    return nextReviewDate <= now;
                }).sort((a, b) => {
                    const dateA = a.nextReview instanceof Date ? a.nextReview : new Date(a.nextReview);
                    const dateB = b.nextReview instanceof Date ? b.nextReview : new Date(b.nextReview);
                    return dateA.getTime() - dateB.getTime();
                }).slice(0, 15); // Limit to 15 for a manageable daily session
            }

            // Get recommended atoms (e.g., lowest difficulty and not in today's queue)
            function getRecommendedAtoms() {
                const todayQueueIds = new Set(getDailyQueue().map(a => a.id));
                return mockData.learningAtoms
                    .filter(atom => atom.difficulty < 3 && !todayQueueIds.has(atom.id)) // Only learning/new atoms not in today's queue
                    .sort((a, b) => a.difficulty - b.difficulty || new Date(a.lastReviewed).getTime() - new Date(b.lastReviewed).getTime())
                    .slice(0, 3); // Show top 3 recommendations
            }

            // Main render function to switch views and update common UI elements
            function render() {
                // Hide all views first
                Object.values(views).forEach(view => view.classList.add('hidden'));
                // Show current view
                if (views[appState.currentView]) {
                    views[appState.currentView].classList.remove('hidden');
                }
                updateActiveNav();
                localStorage.setItem('auralearn_currentView', appState.currentView); // Save current view state

                // Update common UI elements
                dashboardUsername.textContent = mockData.user.name;
                sidebarUsername.textContent = mockData.user.name;
                sidebarUsernameMobile.textContent = mockData.user.name;
                currentStreak.textContent = `üî• ${mockData.user.streak} Days`;
                totalMasteredAtoms.textContent = mockData.user.totalMastered;
                dailyQueueCount.textContent = `${getDailyQueue().length} Atoms`;

                // Render content specific to the current view
                if (appState.currentView === 'dashboard') renderDashboard();
                if (appState.currentView === 'library') renderLibrary();
                if (appState.currentView === 'ai-learning') renderAILearning(); // Call new render function
                if (appState.currentView === 'analytics') renderAnalytics();
                if (appState.currentView === 'focus') renderFocusTools();
                if (appState.currentView === 'learning-hub') renderLearningHub();
                if (appState.currentView === 'settings') renderSettings();
            }

            // Render content for the Dashboard view
            function renderDashboard() {
                const dailyQueue = getDailyQueue();
                const queueList = document.getElementById('daily-queue-list');
                queueList.innerHTML = ''; // Clear previous list items

                if (dailyQueue.length === 0) {
                    queueList.innerHTML = '<li class="p-3 text-secondary text-center list-item-themed">No atoms due for review today. Great job!</li>';
                    startReviewBtn.textContent = 'No Reviews Today';
                    startReviewBtn.disabled = true;
                } else {
                    dailyQueue.forEach(atom => {
                        const subject = mockData.subjects.find(s => s.id === atom.subjectId);
                        const li = document.createElement('li');
                        // Use list-item-themed for dynamic background/border
                        li.className = 'flex items-center justify-between p-3 rounded-lg border list-item-themed hover:list-item-themed';
                        // Add a class for subject color/text if available
                        const subjectColorClass = subject ? `${subject.color} ${subject.textColor}` : 'bg-gray-200 text-gray-800';
                        li.innerHTML = `
                            <div>
                                <p class="font-medium text-primary">${atom.question}</p>
                                <span class="text-xs font-semibold ${subjectColorClass} px-2 py-1 rounded-full">${subject ? subject.name : 'Unknown Subject'}</span>
                            </div>
                            <span class="text-secondary text-lg">‚Ä∫</span>
                        `;
                        queueList.appendChild(li);
                    });
                    startReviewBtn.textContent = `Start Daily Review (${dailyQueue.length} items)`;
                    startReviewBtn.disabled = false;
                }

                const recommendedAtoms = getRecommendedAtoms();
                recommendedAtomsList.innerHTML = '';
                if (recommendedAtoms.length === 0) {
                    recommendedAtomsList.innerHTML = `<p class="text-secondary text-center mt-4">No specific recommendations yet. Start importing content!</p>`;
                } else {
                    recommendedAtoms.forEach(atom => {
                        const subject = mockData.subjects.find(s => s.id === atom.subjectId);
                        const li = document.createElement('div');
                        // Use list-item-themed for dynamic background/border
                        li.className = 'flex items-center justify-between p-3 rounded-lg border list-item-themed hover:list-item-themed';
                        const subjectColorClass = subject ? `${subject.color} ${subject.textColor}` : 'bg-gray-200 text-gray-800';
                        li.innerHTML = `
                            <div>
                                <p class="font-medium text-primary">${atom.question}</p>
                                <span class="text-xs font-semibold ${subjectColorClass} px-2 py-1 rounded-full">${subject ? subject.name : 'Unknown Subject'}</span>
                            </div>
                            <button class="bg-accent-blue text-white text-xs py-1 px-2 rounded-md hover:bg-accent-blue-hover" data-atom-id="${atom.id}">Review</button>
                        `;
                        recommendedAtomsList.appendChild(li);

                        // Attach event listener to the "Review" button
                        const reviewBtn = li.querySelector('button');
                        reviewBtn.addEventListener('click', () => {
                            const atomId = parseInt(reviewBtn.dataset.atomId);
                            const selectedAtom = mockData.learningAtoms.find(a => a.id === atomId);
                            if (selectedAtom) {
                                // Show detail modal with atom question and answer
                                showDetailModal({ title: selectedAtom.question, details: selectedAtom.answer });
                            }
                        });
                    });
                }

                // Daily Challenge Logic
                const today = new Date().toISOString().split('T')[0]; // Get today's date string
                if (mockData.user.lastChallengeDate !== today) {
                    // Reset challenge progress if it's a new day
                    mockData.user.dailyChallengeProgress = 0;
                }
                dailyChallengeText.textContent = `Review 5 atoms to complete today's challenge!`;
                dailyChallengeProgress.style.width = `${(mockData.user.dailyChallengeProgress / 5) * 100}%`;
                dailyChallengeStatus.textContent = `${mockData.user.dailyChallengeProgress}/5 Atoms Reviewed`;

                if (mockData.user.dailyChallengeProgress >= 5 && mockData.user.lastChallengeDate === today) {
                    claimChallengeBtn.classList.remove('hidden');
                } else {
                    claimChallengeBtn.classList.add('hidden');
                }
                saveUserData(); // Save user data after updating challenge progress
            }

            // Render content for the Library view
            function renderLibrary() {
                subjectGrid.innerHTML = '';
                if (mockData.subjects.length === 0) {
                    emptyLibraryMessage.classList.remove('hidden');
                } else {
                    emptyLibraryMessage.classList.add('hidden');
                    mockData.subjects.forEach(subject => {
                        const div = document.createElement('div');
                        div.className = `p-4 rounded-xl shadow-sm border border-border-color ${subject.color} cursor-pointer hover:shadow-md transition-shadow`;
                        div.innerHTML = `
                            <h4 class="font-bold ${subject.textColor}">${subject.name}</h4>
                            <p class="text-sm ${subject.textColor.replace('-800', '-600')}">${subject.atoms} Atoms</p>
                        `;
                        // Add event listener to each subject card to open subject details
                        div.addEventListener('click', () => showSubjectDetails(subject.id));
                        subjectGrid.appendChild(div);
                    });
                }

                // Render AI-Generated Materials
                aiMaterialsList.innerHTML = '';
                if (mockData.aiMaterials.length === 0) {
                    emptyAiMaterialsMessage.classList.remove('hidden');
                } else {
                    emptyAiMaterialsMessage.classList.add('hidden');
                    mockData.aiMaterials.forEach(aiMaterial => {
                        const materialDiv = document.createElement('div');
                        // Use list-item-themed for dynamic background/border
                        materialDiv.className = 'p-3 rounded-lg border list-item-themed hover:list-item-themed cursor-pointer transition-colors';
                        let typeLabel = '';
                        let displayContent = '';

                        if (aiMaterial.type === 'note') {
                            typeLabel = 'AI Note';
                            // Display the HTML directly, use a textContent fallback for snippet
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = aiMaterial.content;
                            displayContent = `<p>${tempDiv.textContent.substring(0, 100)}...</p>`; // Show snippet
                        } else if (aiMaterial.type === 'quiz') {
                            typeLabel = 'AI Quiz';
                            displayContent = `<p>${aiMaterial.content.length} Questions</p>`;
                        } else if (aiMaterial.type === 'keywords') {
                            typeLabel = 'Keywords';
                            displayContent = `<p>${aiMaterial.content.map(k => k.keyword).join(', ')}</p>`;
                        } else if (aiMaterial.type === 'exam-questions') {
                            typeLabel = 'Exam Questions';
                            displayContent = `<p>${aiMaterial.content.length} Questions</p>`;
                        } else if (aiMaterial.type === 'summary') { // New type for Summarize Content
                            typeLabel = 'AI Summary';
                             const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = aiMaterial.content;
                            displayContent = `<p>${tempDiv.textContent.substring(0, 100)}...</p>`; // Show snippet
                        }

                        materialDiv.innerHTML = `
                            <p class="font-semibold text-primary">${aiMaterial.title}</p>
                            <p class="text-xs text-secondary mt-1">${typeLabel} - ${new Date(aiMaterial.timestamp).toLocaleDateString()}</p>
                            ${displayContent}
                        `;
                        materialDiv.addEventListener('click', () => showAIGeneratedMaterial(aiMaterial));
                        aiMaterialsList.appendChild(materialDiv);
                    });
                }
            }

            // Function to show subject details modal with its atoms
            function showSubjectDetails(subjectId) {
                const subject = mockData.subjects.find(s => s.id === subjectId);
                if (!subject) return;

                subjectDetailTitle.textContent = `${subject.name} Atoms`;
                subjectAtomsList.innerHTML = ''; // Clear previous list

                const atomsInSubject = mockData.learningAtoms.filter(atom => atom.subjectId === subjectId);

                if (atomsInSubject.length === 0) {
                    subjectAtomsList.innerHTML = '<p class="text-secondary text-center list-item-themed">No learning atoms in this subject yet.</p>';
                } else {
                    atomsInSubject.forEach(atom => {
                        const atomDiv = document.createElement('div');
                        // Use list-item-themed for dynamic background/border
                        atomDiv.className = 'p-3 rounded-lg border list-item-themed hover:list-item-themed cursor-pointer transition-colors';
                        atomDiv.innerHTML = `
                            <p class="font-semibold text-primary">${atom.question}</p>
                            <p class="text-xs text-secondary mt-1">Difficulty: ${atom.difficulty}/3, Next Review: ${new Date(atom.nextReview).toLocaleDateString()}</p>
                        `;
                        // Make each atom in the list clickable to show its full detail
                        atomDiv.addEventListener('click', (e) => {
                            e.stopPropagation(); // Prevent modal from closing when clicking atom div
                            showDetailModal({ title: atom.question, details: atom.answer });
                        });
                        subjectAtomsList.appendChild(atomDiv);
                    });
                }
                subjectDetailModal.classList.remove('hidden');
            }

            // Close Subject Detail Modal
            closeSubjectDetailModalBtn.addEventListener('click', () => {
                subjectDetailModal.classList.add('hidden');
            });

            // Function to display AI Generated Material in detail modal
            function showAIGeneratedMaterial(aiMaterial) {
                detailTitle.textContent = aiMaterial.title;
                detailLoading.classList.add('hidden'); // Hide loading for AI materials
                detailContentText.classList.remove('hidden'); // Show content text area

                let contentHtml = '';

                if (aiMaterial.type === 'note' || aiMaterial.type === 'summary') {
                    // For notes and summaries, directly use the HTML content provided by AI
                    contentHtml = aiMaterial.content;
                } else if (aiMaterial.type === 'quiz') {
                    contentHtml = '<h4 class="font-semibold text-primary mb-2">Quiz Questions:</h4>';
                    aiMaterial.content.forEach((q, index) => {
                        contentHtml += `<div class="mb-4 p-2 border list-item-themed rounded-md">
                            <p class="font-medium text-primary">Q${index + 1}: ${q.question}</p>`;
                        q.options.forEach((opt, i) => {
                            contentHtml += `<p class="ml-4 text-secondary">${String.fromCharCode(65 + i)}. ${opt}</p>`;
                        });
                        contentHtml += `<p class="text-green-600 mt-1">Correct Answer: ${q.correct_answer}</p></div>`;
                    });
                } else if (aiMaterial.type === 'keywords') {
                    contentHtml = '<h4 class="font-semibold text-primary mb-2">Keywords & Definitions:</h4>';
                    aiMaterial.content.forEach(item => {
                        contentHtml += `<div class="mb-3 p-2 border list-item-themed rounded-md"><p class="font-medium text-primary">${item.keyword}:</p><p>${item.definition}</p></div>`;
                    });
                } else if (aiMaterial.type === 'exam-questions') {
                    contentHtml = '<h4 class="font-semibold text-primary mb-2">Predicted Exam Questions:</h4>';
                    aiMaterial.content.forEach((q, index) => {
                        contentHtml += `<p class="mb-2 p-2 border list-item-themed rounded-md">Q${index + 1}: ${q}</p>`;
                    });
                }
                
                detailContentText.innerHTML = contentHtml;
                detailModal.classList.remove('hidden');
            }


            // Render content for AI Learning view
            function renderAILearning() {
                // Clear previous input and output sections
                aiInputContent.value = '';
                aiContentNewSubjectInput.value = '';
                aiContentNewSubjectInput.classList.add('hidden');
                toggleAIContentNewSubjectInput.textContent = 'Add New Subject';
                aiGeneratedOutput.classList.add('hidden');
                aiOutputContentDisplay.innerHTML = '';
                aiGenerationStatus.classList.add('hidden');
                populateAILearningSubjectSelect(); // Populate subject dropdown for AI Learning
                updateAiInputUI(); // Set initial UI for AI input mode
            }

            function populateAILearningSubjectSelect() {
                aiContentSubjectSelect.innerHTML = '<option value="">Select or Add New Subject</option>';
                mockData.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    aiContentSubjectSelect.appendChild(option);
                });
                aiContentSubjectSelect.value = ""; // Reset selection
            }

            // Function to update AI input UI based on mode toggle
            function updateAiInputUI() {
                if (appState.aiInputMode === 'topic') {
                    aiInputContentLabel.textContent = 'Enter a topic name (e.g., "Quantum Physics", "French Revolution"):';
                    aiInputContent.placeholder = "Enter topic name here...";
                } else { // 'text' mode
                    aiInputContentLabel.textContent = 'Provide text, a topic, or questions for the AI to process:';
                    aiInputContent.placeholder = "Enter text, a topic, or specific questions here... e.g., 'Explain blockchain technology', 'Summarize World War 2 causes', or 'Quiz me on React hooks'.";
                }
            }

            // Listen for changes on aiContentSubjectSelect to ensure new subject input is correctly hidden/shown
            aiContentSubjectSelect.addEventListener('change', () => {
                if (aiContentSubjectSelect.value !== '') { // If an existing subject is selected
                    aiContentNewSubjectInput.classList.add('hidden');
                    toggleAIContentNewSubjectInput.textContent = 'Add New Subject';
                }
                // If 'Select or Add New Subject' is chosen (empty value), keep new subject input state as is
                // This allows the user to click 'Add New Subject' after selecting the empty option
            });


            // Unified AI Generation Function
            async function generateAIContent(type) {
                const buttonMap = {
                    'note': generateAiNotesBtn,
                    'notes-flashcards': generateNotesFlashcardsBtn,
                    'quiz': generateQuizBtn,
                    'keywords': extractKeywordsBtn,
                    'exam-questions': predictExamQuestionsBtn,
                    'summary': summarizeContentBtn // Map new button to 'summary' type
                };
                const currentButton = buttonMap[type];

                aiGenerationStatus.classList.remove('hidden');
                aiGenerationStatus.textContent = 'Generating... Please wait...';
                if (currentButton) currentButton.disabled = true; // Disable button during processing

                aiGeneratedOutput.classList.add('hidden'); // Hide previous output
                aiOutputContentDisplay.innerHTML = ''; // Clear previous output content

                const content = aiInputContent.value.trim();
                if (!content) {
                    showNotification('Please provide some content (topic, text, or questions) for the AI.', true);
                    aiGenerationStatus.classList.add('hidden');
                    if (currentButton) currentButton.disabled = false;
                    return;
                }

                let subjectId;
                let subjectName;
                // Determine subject from input fields
                if (!aiContentNewSubjectInput.classList.contains('hidden') && aiContentNewSubjectInput.value.trim()) {
                    subjectName = aiContentNewSubjectInput.value.trim();
                    subjectId = subjectName.toLowerCase().replace(/\s/g, '-').replace(/[^a-z0-9-]/g, ''); // Sanitize ID
                    // Add new subject if it doesn't exist
                    if (!mockData.subjects.find(s => s.id === subjectId)) {
                        mockData.subjects.push({ id: subjectId, name: subjectName, color: "bg-blue-100", textColor: "text-blue-800", atoms: 0, lastReviewed: null });
                    }
                } else {
                    subjectId = aiContentSubjectSelect.value;
                    if (type === 'notes-flashcards' && !subjectId) { // Only force subject selection for flashcards
                        showNotification('Please select an existing subject or add a new one for Flashcards.', true);
                        aiGenerationStatus.classList.add('hidden');
                        if (currentButton) currentButton.disabled = false;
                        return;
                    }
                    subjectName = mockData.subjects.find(s => s.id === subjectId)?.name || 'General AI Content';
                }
                
                let prompt = '';
                let responseSchema = {};
                let outputTitle = '';
                let savedContentTitle = ''; // Title for the saved AI material

                switch (type) {
                    case 'note':
                        outputTitle = 'AI Notes';
                        savedContentTitle = `AI Notes on: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`;
                        if (appState.aiInputMode === 'topic') {
                            // FIX: Make prompt more explicit about HTML list and bold formatting
                            prompt = `Generate concise, organized notes on the topic: "${content}". Format the notes as HTML using <ul> and <li> tags for bullet points and <strong> tags for bolding key terms. Ensure the entire response is valid HTML. Focus only on key points and important information, designed specifically to help teach and retain the info with no fluff or unnecessary details. Avoid introductions, conclusions, or conversational filler.`;
                        } else {
                            // FIX: Make prompt more explicit about HTML list and bold formatting
                            prompt = `Generate concise, organized notes from the following text. Format the notes as HTML using <ul> and <li> tags for bullet points and <strong> tags for bolding key terms. Ensure the entire response is valid HTML. Focus only on key points and important information, designed specifically to help teach and retain the info with no fluff or unnecessary details. Avoid introductions, conclusions, or conversational filler.
                            Text: "${content}"`;
                        }
                        responseSchema = { type: "STRING" }; // For plain text response
                        break;
                    case 'notes-flashcards':
                        outputTitle = 'Generated Flashcards';
                        savedContentTitle = `Flashcards for: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`;
                        prompt = `Extract key concepts and their explanations, structured as concise question-answer pairs (Learning Atoms). Provide at least 5 pairs if possible. For each pair, the question should be concise and the answer should be informative but brief enough for a flashcard. Ensure no markdown formatting like asterisks or bullet points are used within the question or answer text.`;
                        if (appState.aiInputMode === 'topic') {
                            prompt += ` Based on the topic: "${content}"`;
                        } else {
                            prompt += ` Based on the following text: "${content}"`;
                        }
                        responseSchema = {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "question": { "type": "STRING" },
                                    "answer": { "type": "STRING" }
                                },
                                "propertyOrdering": ["question", "answer"]
                            }
                        };
                        break;
                    case 'quiz':
                        outputTitle = 'Generated Quiz';
                        savedContentTitle = `Quiz on: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`;
                        // Allow dynamic quiz length (simple version)
                        const quizLength = 5; // Default length, could be user input later
                        prompt = `Generate a ${quizLength}-question multiple-choice quiz based on the following content: "${content}". For each question, provide 4 options (A, B, C, D) and indicate the correct answer. Format as JSON, ensuring no markdown characters like asterisks or bullet points are used within the question or option text: [{"question": "...", "options": ["A", "B", "C", "D"], "correct_answer": "A"}, ...]`;
                        responseSchema = {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "question": { "type": "STRING" },
                                    "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                                    "correct_answer": { "type": "STRING" }
                                },
                                "propertyOrdering": ["question", "options", "correct_answer"]
                            }
                        };
                        break;
                    case 'keywords':
                        outputTitle = 'Extracted Keywords';
                        savedContentTitle = `Keywords from: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`;
                        prompt = `Extract up to 10 most important keywords or key phrases and their brief definitions from the following text/topic: "${content}". Format as JSON, ensuring no markdown characters like asterisks or bullet points are used: [{"keyword": "...", "definition": "..."}, ...]`;
                        responseSchema = {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "keyword": { "type": "STRING" },
                                    "definition": { "type": "STRING" }
                                },
                                "propertyOrdering": ["keyword", "definition"]
                            }
                        };
                        break;
                    case 'exam-questions':
                        outputTitle = 'Predicted Exam Questions';
                        savedContentTitle = `Exam Questions for: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`;
                        prompt = `Generate 5 challenging exam-style questions for the subject related to: "${content}". Focus on core concepts and different question types (e.g., multiple choice, short answer, explanation). Provide only the questions, without answers. Format as JSON, ensuring no markdown characters like asterisks or bullet points are used in the questions: ["Q1", "Q2", "Q3", "Q4", "Q5"]`;
                        responseSchema = {
                            type: "ARRAY",
                            items: {
                                type: "STRING"
                            }
                        };
                        break;
                    case 'summary': // New case for 'Summarize Content'
                        outputTitle = 'AI Summary';
                        savedContentTitle = `Summary for: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`;
                        if (appState.aiInputMode === 'topic') {
                            prompt = `Provide a concise, key-point summary of the topic: "${content}". Use HTML paragraphs and <strong> tags for important terms. Keep it brief but informative. Avoid conversational filler.`;
                        } else {
                             prompt = `Provide a concise, key-point summary of the following text: "${content}". Use HTML paragraphs and <strong> tags for important terms. Keep it brief but informative. Avoid conversational filler.`;
                        }
                        responseSchema = { type: "STRING" };
                        break;
                    default:
                        showNotification('Invalid AI generation type.', true);
                        aiGenerationStatus.classList.add('hidden');
                        if (currentButton) currentButton.disabled = false;
                        return;
                }

                try {
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { 
                        contents: chatHistory,
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: responseSchema
                        }
                    };
                    // Special handling for 'note' and 'summary' types which return plain string, not JSON
                    if (type === 'note' || type === 'summary') {
                        delete payload.generationConfig.responseMimeType;
                        delete payload.generationConfig.responseSchema;
                    }

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        let generatedContent;
                        if (type === 'note' || type === 'summary') {
                            generatedContent = result.candidates[0].content.parts[0].text;
                        } else {
                            generatedContent = JSON.parse(result.candidates[0].content.parts[0].text);
                        }

                        if (generatedContent && (Array.isArray(generatedContent) ? generatedContent.length > 0 : true)) {
                            aiOutputTitle.textContent = outputTitle;
                            aiGeneratedOutput.classList.remove('hidden');

                            if (type === 'notes-flashcards') {
                                const subjectObj = mockData.subjects.find(s => s.id === subjectId);
                                generatedContent.forEach(atomData => {
                                    const newAtom = {
                                        id: mockData.learningAtoms.length + 1,
                                        subjectId: subjectId,
                                        question: atomData.question,
                                        answer: atomData.answer,
                                        difficulty: 0,
                                        lastReviewed: new Date(),
                                        nextReview: calculateNextReviewDate(new Date(), 0)
                                    };
                                    mockData.learningAtoms.push(newAtom);
                                    if (subjectObj) {
                                        subjectObj.atoms++; // Increment atom count for the subject
                                    }
                                });
                                showNotification(`Generated flashcards added to your '${subjectName}' subject!`);
                            } else {
                                // For 'note', 'quiz', 'keywords', 'exam-questions', 'summary', save to aiMaterials
                                const newMaterial = {
                                    id: mockData.aiMaterials.length + 1,
                                    type: type,
                                    title: savedContentTitle,
                                    content: generatedContent, // Save the actual generated content
                                    timestamp: new Date().toISOString(),
                                    subjectId: subjectId // Store optional subject ID
                                };
                                mockData.aiMaterials.push(newMaterial);
                                showNotification(`${outputTitle} generated and saved to 'AI Materials'!`);
                            }

                            // Display generated content in the output area regardless of where it's saved
                            if (type === 'note' || type === 'summary') {
                                aiOutputContentDisplay.innerHTML = generatedContent; // Directly render HTML
                            } else if (type === 'quiz') {
                                aiOutputContentDisplay.innerHTML = '<h4 class="font-semibold text-primary mb-2">Generated Quiz:</h4>';
                                generatedContent.forEach((q, index) => {
                                    const quizItem = document.createElement('div');
                                    quizItem.className = 'p-3 rounded-lg border list-item-themed';
                                    let optionsHtml = q.options.map((opt, i) => `<p class="ml-4">${String.fromCharCode(65 + i)}. ${opt}</p>`).join('');
                                    quizItem.innerHTML = `
                                        <p class="font-semibold text-primary">Q${index + 1}: ${q.question}</p>
                                        ${optionsHtml}
                                        <p class="text-green-600 mt-2">Correct Answer: ${q.correct_answer}</p>
                                    `;
                                    aiOutputContentDisplay.appendChild(quizItem);
                                });
                            } else if (type === 'keywords') {
                                aiOutputContentDisplay.innerHTML = '<h4 class="font-semibold text-primary mb-2">Extracted Keywords:</h4>';
                                generatedContent.forEach(item => {
                                    const keywordItem = document.createElement('div');
                                    keywordItem.className = 'p-3 rounded-lg border list-item-themed';
                                    keywordItem.innerHTML = `<p class="font-semibold text-primary">${item.keyword}:</p><p>${item.definition}</p>`;
                                    aiOutputContentDisplay.appendChild(keywordItem);
                                });
                            } else if (type === 'exam-questions') {
                                aiOutputContentDisplay.innerHTML = '<h4 class="font-semibold text-primary mb-2">Predicted Exam Questions:</h4>';
                                generatedContent.forEach((q, index) => {
                                    const questionItem = document.createElement('p');
                                    questionItem.className = 'p-3 rounded-lg border list-item-themed';
                                    questionItem.textContent = `Q${index + 1}: ${q}`;
                                    aiOutputContentDisplay.appendChild(questionItem);
                                });
                            }
                            saveUserData(); // Save mockData after any changes
                            render(); // Re-render to update dashboard/library counts
                        } else {
                            showNotification('AI did not generate any content. Try a different input or subject.', true);
                            aiGeneratedOutput.classList.add('hidden');
                        }
                    } else {
                        showNotification('Error: Could not process content with AI. Invalid response structure or API error.', true);
                        console.error("AI Response Error:", result);
                    }
                } catch (error) {
                    console.error("Error generating AI content:", error);
                    showNotification('Failed to connect to AI service or generate content. Please try again.', true);
                } finally {
                    aiGenerationStatus.classList.add('hidden');
                    if (currentButton) currentButton.disabled = false;
                }
            }

            // Charts instance storage
            let charts = {};
            // Function to destroy existing charts before re-rendering
            function destroyCharts() {
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {}; // Reset charts object
            }

            // Render content for the Analytics view (including charts)
            function renderAnalytics() {
                destroyCharts(); // Destroy existing charts to prevent issues on theme change/re-render

                // Get current theme colors for chart styling
                const primaryTextColor = getComputedStyle(document.body).getPropertyValue('--text-primary');
                const secondaryTextColor = getComputedStyle(document.body).getPropertyValue('--text-secondary');
                const accentBlueColor = getComputedStyle(document.body).getPropertyValue('--accent-blue');
                const borderDivColor = getComputedStyle(document.body).getPropertyValue('--border-color');

                // Mastery Breakdown Chart
                const masteryCtx = document.getElementById('masteryChart').getContext('2d');
                charts.mastery = new Chart(masteryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Mastered', 'Learning', 'New'],
                        datasets: [{
                            data: [
                                mockData.user.totalMastered,
                                mockData.learningAtoms.filter(a => a.difficulty < 3 && a.difficulty > 0).length, // Learning atoms
                                mockData.learningAtoms.filter(a => a.difficulty === 0).length // New atoms
                            ],
                            // Dynamically set background colors based on theme, ensuring contrast
                            backgroundColor: [
                                getComputedStyle(document.body).getPropertyValue('--text-green'),
                                getComputedStyle(document.body).getPropertyValue('--text-orange'),
                                getComputedStyle(document.body).getPropertyValue('--text-secondary')
                            ],
                            borderColor: getComputedStyle(document.body).getPropertyValue('--bg-secondary'), // Match background
                            borderWidth: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { position: 'bottom', labels: { color: primaryTextColor } }, // Legend text color
                            tooltip: { 
                                callbacks: {
                                    label: (context) => {
                                        let label = context.label || '';
                                        if (label) { label += ': '; }
                                        label += Math.round(context.parsed) + ' atoms';
                                        return label;
                                    },
                                    title: (tooltipItems) => {
                                        const title = tooltipItems[0].label;
                                        return title.length > 16 ? title.substring(0, 15) + '...' : title;
                                    }
                                }
                            }
                        }
                    }
                });

                // Study Activity Chart
                const activityCtx = document.getElementById('activityChart').getContext('2d');
                charts.activity = new Chart(activityCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [{ label: 'Hours Studied', data: [2.5, 3.0, 1.8, 4.0, 2.2, 3.5, 1.5], backgroundColor: accentBlueColor }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false }, // Hide legend for single dataset
                            tooltip: { 
                                callbacks: {
                                    label: (context) => {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        label += context.parsed.y + ' hrs';
                                        return label;
                                    },
                                    title: (tooltipItems) => {
                                        const title = tooltipItems[0].label;
                                        return title.length > 16 ? title.substring(0, 15) + '...' : title;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { ticks: { color: secondaryTextColor }, grid: { color: borderDivColor } },
                            y: { beginAtZero: true, ticks: { color: secondaryTextColor }, grid: { color: borderDivColor } }
                        }
                    }
                });
                
                // Knowledge Growth Chart
                const growthCtx = document.getElementById('growthChart').getContext('2d');
                charts.growth = new Chart(growthCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Total Atoms Mastered',
                            data: [50, 75, 90, 120, 155, mockData.user.totalMastered], // Example cumulative data
                            fill: true,
                            borderColor: accentBlueColor,
                            backgroundColor: accentBlueColor.replace('rgb', 'rgba').replace(')', ', 0.1)'), // Lighter shade for fill
                            tension: 0.3 // Smooth curves
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { 
                            legend: { display: false },
                            tooltip: { 
                                callbacks: {
                                    label: (context) => {
                                        let label = context.dataset.label || '';
                                        if (label) { label += ': '; }
                                        label += context.parsed.y + ' atoms';
                                        return label;
                                    },
                                    title: (tooltipItems) => {
                                        const title = tooltipItems[0].label;
                                        return title.length > 16 ? title.substring(0, 15) + '...' : title;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { ticks: { color: secondaryTextColor }, grid: { color: borderDivColor } },
                            y: { beginAtZero: true, ticks: { color: secondaryTextColor }, grid: { color: borderDivColor } }
                        }
                    }
                });

                // Render Learning Goals
                goalsList.innerHTML = '';
                if (mockData.user.learningGoals.length === 0) {
                    emptyGoalsMessage.classList.remove('hidden');
                } else {
                    emptyGoalsMessage.classList.add('hidden');
                    mockData.user.learningGoals.forEach(goal => {
                        const progress = goal.targetType === 'atoms' 
                            ? Math.min(100, (mockData.user.totalMastered / goal.targetValue) * 100)
                            : Math.min(100, (mockData.user.weeklyStudyTime / goal.targetValue) * 100);
                        const goalDiv = document.createElement('div');
                        // Use list-item-themed for dynamic background/border
                        goalDiv.className = 'p-4 rounded-lg border list-item-themed';
                        goalDiv.innerHTML = `
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-primary">${goal.name}</h4>
                                <span class="text-sm text-secondary">${new Date(goal.endDate).toLocaleDateString()}</span>
                            </div>
                            <div class="w-full bg-border-color rounded-full h-2.5">
                                <div class="bg-accent-blue h-2.5 rounded-full" style="width: ${progress}%;"></div>
                            </div>
                            <p class="text-secondary text-sm mt-2">Progress: ${Math.round(progress)}%</p>
                        `;
                        goalsList.appendChild(goalDiv);
                    });
                }
            }

            // Render content for the Focus Tools view
            function renderFocusTools() {
                const soundscapesContainer = document.getElementById('soundscapes');
                soundscapesContainer.innerHTML = '';
                mockData.soundscapes.forEach(sound => {
                    const button = document.createElement('button');
                    // Use list-item-themed for dynamic background/border
                    button.className = 'soundscape-btn flex items-center gap-2 p-4 rounded-lg border list-item-themed hover:list-item-themed text-primary';
                    button.innerHTML = `<span class="text-2xl">${sound.icon}</span><span class="font-semibold">${sound.name}</span>`;
                    button.dataset.file = sound.file; // Store filename for simulated playback
                    soundscapesContainer.appendChild(button);
                });
                updatePomodoroDisplay(); // Update Pomodoro timer display
            }

            // Render content for the Learning Hub view
            function renderLearningHub() {
                const learningHubContent = document.getElementById('learning-hub-content');
                learningHubContent.innerHTML = ''; // Clear previous content
                const currentCategory = mockData.learningHubContent[appState.learningHubCategory];

                currentCategory.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-secondary p-5 rounded-xl shadow-sm border border-border-color cursor-pointer hover:shadow-md transition-shadow';
                    card.innerHTML = `<h4 class="font-bold text-primary mb-2">${item.title}</h4><p class="text-secondary text-sm">${item.summary}</p>`;
                    card.addEventListener('click', () => showDetailModal(item)); // Click to show full details
                    learningHubContent.appendChild(card);
                });

                // Update active tab styling
                document.querySelectorAll('.tab-button').forEach(btn => {
                    if (btn.dataset.category === appState.learningHubCategory) {
                        btn.classList.add('bg-accent-blue', 'text-white');
                        btn.classList.remove('hover:bg-border-color', 'text-primary'); // Remove text-primary too
                    } else {
                        btn.classList.remove('bg-accent-blue', 'text-white');
                        btn.classList.add('hover:bg-border-color', 'text-primary'); // Add text-primary back
                    }
                });
            }

            // Render content for the Settings view
            function renderSettings() {
                usernameInput.value = mockData.user.name;
                // Load current SRS intervals into input fields
                intervalPerfectInput.value = mockData.user.srsIntervals.perfect;
                intervalGoodInput.value = mockData.user.srsIntervals.good;
                intervalStruggledInput.value = mockData.user.srsIntervals.struggled;
                intervalForgotInput.value = mockData.user.srsIntervals.forgot;
            }

            // Update active navigation item styling
            function updateActiveNav() {
                navLinks.forEach(link => {
                    if (link.dataset.view === appState.currentView) {
                        link.classList.add('nav-item-active');
                    } else {
                        link.classList.remove('nav-item-active');
                    }
                });
            }

            // Function to navigate to a different view
            function navigate(view) {
                appState.currentView = view;
                render();
            }
            
            // Event listeners for navigation items
            document.querySelectorAll('nav').forEach(nav => {
                nav.addEventListener('click', (e) => {
                    const navItem = e.target.closest('.nav-item');
                    if (navItem) {
                        e.preventDefault(); // Prevent default link behavior
                        const view = navItem.dataset.view;
                        navigate(view);
                        // Close mobile sidebar if open
                        if (!mobileSidebarContainer.classList.contains('hidden')) {
                            toggleMobileMenu();
                        }
                    }
                });
            });

            // Toggle mobile sidebar visibility
            function toggleMobileMenu() {
                const isHidden = mobileSidebarContainer.classList.contains('hidden');
                if (isHidden) {
                    mobileSidebarContainer.classList.remove('hidden');
                    // Use a small timeout to allow CSS transition to apply
                    setTimeout(() => { mobileSidebar.classList.remove('-translate-x-full'); }, 10);
                } else {
                    mobileSidebar.classList.add('-translate-x-full');
                    setTimeout(() => { mobileSidebarContainer.classList.add('hidden'); }, 300); // Wait for transition
                }
            }

            // Mobile menu button event listeners
            mobileMenuButton.addEventListener('click', toggleMobileMenu);
            closeMenuButton.addEventListener('click', toggleMobileMenu);
            mobileSidebarContainer.addEventListener('click', (e) => {
                // Close sidebar if clicked outside the sidebar content
                if (e.target === mobileSidebarContainer) {
                    toggleMobileMenu();
                }
            });

            // Start a new study session
            function startStudySession() {
                appState.studySession.isActive = true;
                appState.studySession.queue = getDailyQueue(); 
                appState.studySession.currentIndex = 0;
                appState.studySession.atomsReviewedInSession = 0; // Reset for new session

                if (appState.studySession.queue.length === 0) {
                    showNotification('Your daily review queue is empty! Import some content to get started.', true);
                    navigate('library'); // Redirect to library if no atoms to review
                    return;
                }
                navigate('study'); // Switch to study view
                renderCurrentCard(); // Load the first card
            }

            // Render the current flashcard in the study session
            function renderCurrentCard() {
                if (appState.studySession.currentIndex >= appState.studySession.queue.length) {
                    endStudySession(); // End session if all cards reviewed
                    return;
                }
                flashcardContainer.classList.remove('flipped'); // Ensure card is flipped to front
                
                const currentAtom = appState.studySession.queue[appState.studySession.currentIndex];
                const subject = mockData.subjects.find(s => s.id === currentAtom.subjectId);

                document.getElementById('card-subject-front').textContent = subject ? subject.name : 'Unknown';
                document.getElementById('card-subject-back').textContent = subject ? subject.name : 'Unknown';
                document.getElementById('card-question').textContent = currentAtom.question;
                document.getElementById('card-answer').textContent = currentAtom.answer;
                
                // Update progress bar and text
                const totalItems = appState.studySession.queue.length;
                const progress = ((appState.studySession.currentIndex + 1) / totalItems) * 100;
                document.getElementById('study-progress-bar').style.width = `${progress}%`;
                document.getElementById('study-progress-text').textContent = `Atom ${appState.studySession.currentIndex + 1} of ${totalItems}`;
            }

            // End the current study session
            function endStudySession() {
                appState.studySession.isActive = false;
                showReflectionModal(); // Prompt for reflection after session
                
                // Update daily challenge progress and streak
                const today = new Date().toISOString().split('T')[0];
                if (mockData.user.lastChallengeDate !== today) {
                    // This logic might need refinement if 'streak' means consecutive days.
                    // For simplicity, if it's a new day since last challenge date, increment streak.
                    // A more robust streak would check if yesterday was also a study day.
                    mockData.user.streak = (mockData.user.streak || 0) + 1;
                }
                mockData.user.lastChallengeDate = today; // Always update last challenge date
                mockData.user.dailyChallengeProgress += appState.studySession.atomsReviewedInSession;
                saveUserData(); // Save updated user data
            }
            
            // Study session button event listeners
            startReviewBtn.addEventListener('click', startStudySession);
            showAnswerBtn.addEventListener('click', () => { flashcardContainer.classList.add('flipped'); });
            
            recallButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    const rating = parseInt(e.currentTarget.dataset.rating);
                    const currentAtom = appState.studySession.queue[appState.studySession.currentIndex];
                    
                    // Update total mastered atoms count
                    if (currentAtom.difficulty !== 3 && rating === 3) {
                        mockData.user.totalMastered = (mockData.user.totalMastered || 0) + 1;
                    } else if (currentAtom.difficulty === 3 && rating < 3) {
                        // If an atom was mastered but then recalled poorly, decrement mastery count
                        mockData.user.totalMastered = Math.max(0, (mockData.user.totalMastered || 0) - 1);
                    }

                    currentAtom.lastReviewed = new Date();
                    currentAtom.difficulty = rating;
                    currentAtom.nextReview = calculateNextReviewDate(currentAtom.lastReviewed, currentAtom.difficulty);
                    
                    saveUserData(); // Save atom and user data after rating
                    console.log(`Rated card ${currentAtom.id} with rating: ${rating}. Next review: ${currentAtom.nextReview.toLocaleDateString()}`);
                    
                    flashcardContainer.classList.remove('flipped'); // Flip back to front for next card
                    appState.studySession.currentIndex++;
                    appState.studySession.atomsReviewedInSession++;
                    // Short delay before rendering next card for smoother transition
                    setTimeout(renderCurrentCard, 300);
                });
            });

            // Daily Challenge Claim Button
            claimChallengeBtn.addEventListener('click', () => {
                const today = new Date().toISOString().split('T')[0];
                if (mockData.user.dailyChallengeProgress >= 5 && mockData.user.lastChallengeDate === today) {
                    showNotification('Congratulations! You claimed your daily challenge reward!');
                    // Reset challenge for the next day/session
                    mockData.user.dailyChallengeProgress = 0;
                    mockData.user.lastChallengeDate = null; // Mark as null so it resets correctly tomorrow for potential new streak
                    saveUserData();
                    renderDashboard(); // Re-render dashboard to update UI
                } else {
                    showNotification('You have not completed the daily challenge yet!', true);
                }
            });


            const pomodoroTimerEl = document.getElementById('pomodoro-timer');
            const pomodoroStatusEl = document.getElementById('pomodoro-status');
            
            // Update Pomodoro timer display
            function updatePomodoroDisplay() {
                const minutes = Math.floor(appState.pomodoro.timeLeft / 60).toString().padStart(2, '0');
                const seconds = (appState.pomodoro.timeLeft % 60).toString().padStart(2, '0');
                pomodoroTimerEl.textContent = `${minutes}:${seconds}`;
            }

            // Pomodoro timer tick function
            function tick() {
                if (appState.pomodoro.timeLeft > 0) {
                    appState.pomodoro.timeLeft--;
                    updatePomodoroDisplay();
                } else {
                    clearInterval(appState.pomodoro.timerId);
                    appState.pomodoro.isRunning = false;
                    if (appState.pomodoro.mode === 'work') {
                        appState.pomodoro.mode = 'break';
                        appState.pomodoro.timeLeft = 5 * 60; // 5-minute break
                        pomodoroStatusEl.textContent = "Time for a short break!";
                    } else {
                        appState.pomodoro.mode = 'work';
                        appState.pomodoro.timeLeft = 25 * 60; // 25-minute work
                        pomodoroStatusEl.textContent = "Time to focus!";
                    }
                    showNotification(`${appState.pomodoro.mode === 'work' ? 'Break' : 'Focus'} time is over!`);
                    updatePomodoroDisplay();
                }
            }

            // Pomodoro controls event listeners
            document.getElementById('pomodoro-start').addEventListener('click', () => {
                if (!appState.pomodoro.isRunning) {
                    appState.pomodoro.isRunning = true;
                    appState.pomodoro.timerId = setInterval(tick, 1000);
                }
            });
            document.getElementById('pomodoro-pause').addEventListener('click', () => {
                clearInterval(appState.pomodoro.timerId);
                appState.pomodoro.isRunning = false;
            });
            document.getElementById('pomodoro-reset').addEventListener('click', () => {
                clearInterval(appState.pomodoro.timerId);
                appState.pomodoro.isRunning = false;
                appState.pomodoro.mode = 'work';
                appState.pomodoro.timeLeft = 25 * 60;
                pomodoroStatusEl.textContent = "Time to focus!";
                updatePomodoroDisplay();
            });

            // Ambient soundscapes simulation
            document.getElementById('soundscapes').addEventListener('click', (e) => {
                if (e.target.closest('.soundscape-btn')) {
                    const soundName = e.target.closest('.soundscape-btn').dataset.file;
                    showNotification(`Playing simulated ${soundName.replace('.mp3', '')} soundscape... (Feature requires actual audio files)`);
                }
            });

            // Onboarding functions
            function showOnboarding() {
                onboardingModal.classList.remove('hidden');
                currentOnboardingStep = 1;
                updateOnboardingStep();
            }

            function updateOnboardingStep() {
                // Hide all steps
                if (onboardingSteps['step-1']) onboardingSteps['step-1'].classList.add('hidden');
                if (onboardingSteps['step-2']) onboardingSteps['step-2'].classList.add('hidden');
                if (onboardingSteps['step-3']) onboardingSteps['step-3'].classList.add('hidden');
                
                // Show current step
                const currentStepElement = onboardingSteps[`step-${currentOnboardingStep}`];
                if (currentStepElement) {
                    currentStepElement.classList.remove('hidden');
                }

                // Update text and button label
                if (currentOnboardingStep === 1) {
                    onboardingText.textContent = "Let's set up your personalized learning journey. Tell us about your primary learning goals.";
                    onboardingNextBtn.textContent = "Next";
                } else if (currentOnboardingStep === 2) {
                    onboardingText.textContent = "How much time can you realistically dedicate to learning each week?";
                    onboardingNextBtn.textContent = "Next";
                } else if (currentOnboardingStep === 3) {
                    onboardingText.textContent = "What subjects or areas are you currently focusing on?";
                    onboardingNextBtn.textContent = "Finish Setup";
                } else {
                    completeOnboarding();
                }
            }

            function completeOnboarding() {
                const goal = document.getElementById('goal-input').value;
                const time = document.getElementById('time-input').value;
                const subjects = document.getElementById('subjects-input').value;

                // Populate user data with onboarding inputs
                mockData.user.learningGoals = goal ? [{ id: 'initial-goal', name: goal, targetType: 'general', targetValue: 0, currentProgress: 0, endDate: new Date().toISOString() }] : [];
                mockData.user.weeklyStudyTime = parseInt(time) || 0;
                mockData.user.focusedSubjects = subjects.split(',').map(s => s.trim()).filter(s => s);

                localStorage.setItem('auralearn_onboardingCompleted', 'true');
                appState.onboardingCompleted = true;
                onboardingModal.classList.add('hidden');
                saveUserData();
                showNotification('Onboarding complete! Your personalized journey begins now.');
                render(); // Re-render main app
            }

            onboardingNextBtn.addEventListener('click', () => {
                currentOnboardingStep++;
                updateOnboardingStep();
            });
            onboardingSkipBtn.addEventListener('click', () => {
                localStorage.setItem('auralearn_onboardingCompleted', 'true');
                appState.onboardingCompleted = true;
                onboardingModal.classList.add('hidden');
                saveUserData();
                render();
            });

            // Toggle new subject input for AI Learning section
            toggleAIContentNewSubjectInput.addEventListener('click', () => {
                if (aiContentNewSubjectInput.classList.contains('hidden')) {
                    aiContentNewSubjectInput.classList.remove('hidden');
                    aiContentSubjectSelect.classList.add('hidden');
                    toggleAIContentNewSubjectInput.textContent = 'Select Existing Subject';
                } else {
                    aiContentNewSubjectInput.classList.add('hidden');
                    aiContentSubjectSelect.classList.remove('hidden');
                    toggleAIContentNewSubjectInput.textContent = 'Add New Subject';
                }
            });

            // Listen for changes on aiContentSubjectSelect to ensure new subject input is correctly hidden/shown
            aiContentSubjectSelect.addEventListener('change', () => {
                if (aiContentSubjectSelect.value !== '') { // If an existing subject is selected
                    aiContentNewSubjectInput.classList.add('hidden');
                    aiContentNewSubjectInput.value = ''; // Clear new subject input
                    toggleAIContentNewSubjectInput.textContent = 'Add New Subject';
                }
                // If 'Select or Add New Subject' is chosen (empty value), keep new subject input state as is
                // This allows the user to click 'Add New Subject' after selecting the empty option
            });

            // Event listener for the AI input mode toggle
            aiInputModeToggle.addEventListener('change', () => {
                appState.aiInputMode = aiInputModeToggle.checked ? 'topic' : 'text';
                updateAiInputUI();
            });

            // AI Learning buttons event listeners
            generateAiNotesBtn.addEventListener('click', () => generateAIContent('note')); // New AI Notes
            generateNotesFlashcardsBtn.addEventListener('click', () => generateAIContent('notes-flashcards'));
            generateQuizBtn.addEventListener('click', () => generateAIContent('quiz'));
            extractKeywordsBtn.addEventListener('click', () => generateAIContent('keywords'));
            predictExamQuestionsBtn.addEventListener('click', () => generateAIContent('exam-questions'));
            summarizeContentBtn.addEventListener('click', () => generateAIContent('summary')); // New event listener


            // Quick Add Atom Modal handlers
            quickAddAtomBtnDashboard.addEventListener('click', showQuickAddAtomModal);
            quickAddAtomBtnLibrary.addEventListener('click', showQuickAddAtomModal);

            function showQuickAddAtomModal() {
                quickAddAtomModal.classList.remove('hidden');
                quickAddQuestionInput.value = '';
                quickAddAnswerInput.value = '';
                newSubjectInput.value = '';
                newSubjectInput.classList.add('hidden'); // Hide new subject input by default
                quickAddSubjectSelect.classList.remove('hidden'); // Show select by default
                toggleNewSubjectInputBtn.textContent = 'Add New Subject';
                populateQuickAddSubjectSelect();
            }

            closeQuickAddModalBtn.addEventListener('click', () => {
                quickAddAtomModal.classList.add('hidden');
            });

            toggleNewSubjectInputBtn.addEventListener('click', () => {
                if (newSubjectInput.classList.contains('hidden')) {
                    newSubjectInput.classList.remove('hidden');
                    quickAddSubjectSelect.classList.add('hidden');
                    quickAddSubjectSelect.value = ''; // Clear selected subject
                    toggleNewSubjectInputBtn.textContent = 'Select Existing Subject';
                } else {
                    newSubjectInput.classList.add('hidden');
                    newSubjectInput.value = ''; // Clear new subject input
                    quickAddSubjectSelect.classList.remove('hidden');
                    toggleNewSubjectInputBtn.textContent = 'Add New Subject';
                }
            });

            // Listen for changes on quickAddSubjectSelect to ensure new subject input is correctly hidden/shown
            quickAddSubjectSelect.addEventListener('change', () => {
                if (quickAddSubjectSelect.value !== '') { // If an existing subject is selected
                    newSubjectInput.classList.add('hidden');
                    newSubjectInput.value = ''; // Clear new subject input
                    toggleNewSubjectInputBtn.textContent = 'Add New Subject';
                }
                // If 'Select a Subject' is chosen (empty value), keep new subject input state as is
                // This allows the user to click 'Add New Subject' after selecting the empty option
            });

            function populateQuickAddSubjectSelect() {
                quickAddSubjectSelect.innerHTML = '<option value="">Select a Subject</option>';
                mockData.subjects.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject.id;
                    option.textContent = subject.name;
                    quickAddSubjectSelect.appendChild(option);
                });
            }

            addAtomBtn.addEventListener('click', () => {
                let subjectId;
                let subjectName;
                // Determine subject from input fields
                if (!newSubjectInput.classList.contains('hidden') && newSubjectInput.value.trim()) {
                    subjectName = newSubjectInput.value.trim();
                    subjectId = subjectName.toLowerCase().replace(/\s/g, '-').replace(/[^a-z0-9-]/g, ''); // Sanitize ID
                    // Add new subject if it doesn't exist
                    if (!mockData.subjects.find(s => s.id === subjectId)) {
                        mockData.subjects.push({ id: subjectId, name: subjectName, color: "bg-blue-100", textColor: "text-blue-800", atoms: 0, lastReviewed: new Date().toISOString().split('T')[0] });
                    }
                } else {
                    subjectId = quickAddSubjectSelect.value;
                    if (!subjectId) {
                        showNotification('Please select an existing subject or add a new one.', true);
                        return;
                    }
                    subjectName = mockData.subjects.find(s => s.id === subjectId).name;
                }

                const question = quickAddQuestionInput.value.trim();
                const answer = quickAddAnswerInput.value.trim();

                if (!question || !answer) {
                    showNotification('Please enter both a question/concept and an answer/explanation.', true);
                    return;
                }

                const newAtom = {
                    id: mockData.learningAtoms.length + 1,
                    subjectId: subjectId,
                    question: question,
                    answer: answer,
                    difficulty: 0, // New atoms start at 0 difficulty
                    lastReviewed: new Date(),
                    nextReview: calculateNextReviewDate(new Date(), 0)
                };
                mockData.learningAtoms.push(newAtom);

                // Update atom count for the subject
                const subjectObj = mockData.subjects.find(s => s.id === subjectId);
                if (subjectObj) {
                    subjectObj.atoms = (subjectObj.atoms || 0) + 1;
                }

                saveUserData(); // Save updated data
                showNotification('Learning Atom added successfully!');
                quickAddAtomModal.classList.add('hidden');
                render(); // Re-render UI to reflect changes
            });

            // Add Goal Modal handlers
            addGoalBtn.addEventListener('click', () => {
                addGoalModal.classList.remove('hidden');
                goalNameInput.value = '';
                goalTargetValueInput.value = '';
                goalEndDateInput.value = '';
            });

            closeAddGoalModalBtn.addEventListener('click', () => {
                addGoalModal.classList.add('hidden');
            });

            createGoalBtn.addEventListener('click', () => {
                const name = goalNameInput.value.trim();
                const targetType = goalTargetTypeSelect.value;
                const targetValue = parseInt(goalTargetValueInput.value);
                const endDate = goalEndDateInput.value; 

                if (!name || !targetValue || !endDate) {
                    showNotification('Please fill in all goal fields.', true);
                    return;
                }
                if (isNaN(targetValue) || targetValue <= 0) {
                    showNotification('Target value must be a positive number.', true);
                    return;
                }

                const newGoal = {
                    id: `goal-${mockData.user.learningGoals.length + 1}`,
                    name: name,
                    targetType: targetType,
                    targetValue: targetValue,
                    currentProgress: 0, // Goals start at 0 progress
                    endDate: endDate
                };
                mockData.user.learningGoals.push(newGoal);
                saveUserData();
                showNotification('Goal created successfully!');
                addGoalModal.classList.add('hidden');
                render(); // Re-render UI to update analytics goals
            });

            // Reflection Modal handlers
            function showReflectionModal() {
                reflectionModal.classList.remove('hidden');
                reflectionTextarea.value = ''; // Clear text area
            }

            closeReflectionModalBtn.addEventListener('click', () => {
                reflectionModal.classList.add('hidden');
                navigate('dashboard'); // Go back to dashboard
            });

            saveReflectionBtn.addEventListener('click', () => {
                const reflectionText = reflectionTextarea.value.trim();
                if (reflectionText) {
                    console.log("User Reflection:", reflectionText);
                    showNotification('Reflection saved! Thank you for your insights.');
                } else {
                    showNotification('No reflection entered.');
                }
                reflectionModal.classList.add('hidden');
                navigate('dashboard'); // Go back to dashboard
            });

            // Global Search functionality
            globalSearchInput.addEventListener('input', () => {
                const query = globalSearchInput.value.toLowerCase();
                // Only filter if query is long enough or cleared
                if (query.length > 2 || query.length === 0) {
                    filterContent(query);
                }
            });

            // Placeholder for filter content logic (can be expanded)
            function filterContent(query) {
                const allAtoms = mockData.learningAtoms;
                const filteredAtoms = allAtoms.filter(a => 
                    a.question.toLowerCase().includes(query) || 
                    a.answer.toLowerCase().includes(query) ||
                    mockData.subjects.find(s => s.id === a.subjectId)?.name.toLowerCase().includes(query)
                );
                console.log("Search Results (Atoms):", filteredAtoms);
                // For now, it just logs. In a real app, you'd render these results.
                // If on learning hub, re-render with filtered content
                if (appState.currentView === 'learning-hub') {
                    // This is a placeholder; actual filtering of Learning Hub content would need implementation
                    renderLearningHub(); 
                }
                // Provide a simple notification for global search that disappears
                if (query.length > 0 && filteredAtoms.length > 0 && appState.currentView !== 'study' && appState.currentView !== 'library' && appState.currentView !== 'ai-learning') {
                    showNotification(`Found ${filteredAtoms.length} matching atoms! Check your Library for full list.`);
                } else if (query.length > 0 && filteredAtoms.length === 0 && appState.currentView !== 'study' && appState.currentView !== 'ai-learning') {
                    showNotification('No matching items found.', true);
                }
            }

            // Learning Hub Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    appState.learningHubCategory = e.target.dataset.category;
                    renderLearningHub();
                });
            });

            // Detail Modal handlers (for Learning Hub content and Recommended Atoms)
            async function showDetailModal(item) {
                detailTitle.textContent = item.title;
                detailModal.classList.remove('hidden');
                detailContentText.classList.add('hidden'); // Hide text content initially
                detailLoading.classList.remove('hidden'); // Show loading indicator

                // Check if details are already expanded or need expansion (e.g., if details are short)
                // For Learning Hub, we will always regenerate for detailed content.
                let contentToDisplay = item.details;
                
                // If the original detail is short (e.g., less than 200 chars), then call LLM for full explanation.
                // This logic ensures that the LLM is only called if `item.details` needs to be expanded
                // (i.e. is not already a long, detailed explanation from initial mockData)
                if (item.details.length < 200 || !item.llm_expanded) { // llm_expanded is a new flag I'll add after expansion
                    try {
                        const prompt = `Provide a detailed, comprehensive, and practical explanation of the concept or technique "${item.title}". The explanation should be informative, easy to understand, and include actionable insights or real-world relevance where appropriate. Use clear paragraphs, subheadings (h3, h4 tags), and HTML unordered lists (<ul>, <li>) for key points. Use <strong> tags for important terms. Do not include any conversational filler.`;
                        
                        let chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                        const payload = { contents: chatHistory };
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        const result = await response.json();

                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            contentToDisplay = result.candidates[0].content.parts[0].text;
                            item.details = contentToDisplay; // Update item in mockData for subsequent views
                            item.llm_expanded = true; // Mark as expanded by LLM
                        } else {
                            console.error("LLM did not return valid content for Learning Hub explanation.");
                            showNotification('Failed to generate detailed explanation. Showing original content.', true);
                        }
                    } catch (error) {
                        console.error("Error fetching detailed explanation from LLM:", error);
                        showNotification('Error fetching detailed explanation. Showing original content.', true);
                    }
                }
                
                detailLoading.classList.add('hidden'); // Hide loading indicator
                detailContentText.classList.remove('hidden'); // Show content text area
                detailContentText.innerHTML = contentToDisplay; // Set the content (either original or LLM-generated)
            }


            closeDetailModalBtn.addEventListener('click', () => {
                detailModal.classList.add('hidden');
            });

            // User Profile - Save Username
            saveUsernameBtn.addEventListener('click', () => {
                const newUsername = usernameInput.value.trim();
                if (newUsername) {
                    mockData.user.name = newUsername;
                    saveUserData();
                    showNotification('Username updated successfully!');
                    render(); // Re-render to update all username displays
                } else {
                    showNotification('Username cannot be empty.', true);
                }
            });

            // Save Spaced Repetition Intervals
            saveIntervalsBtn.addEventListener('click', () => {
                const perfect = parseFloat(intervalPerfectInput.value);
                const good = parseFloat(intervalGoodInput.value);
                const struggled = parseFloat(intervalStruggledInput.value);
                const forgot = parseFloat(intervalForgotInput.value);

                if (isNaN(perfect) || isNaN(good) || isNaN(struggled) || isNaN(forgot) ||
                    perfect < 0 || good < 0 || struggled < 0 || forgot < 0) {
                    showNotification('Please enter valid positive numbers for all intervals.', true);
                    return;
                }

                mockData.user.srsIntervals = { perfect, good, struggled, forgot };
                saveUserData();
                showNotification('Spaced Repetition intervals saved!');
            });


            // Theme switching
            themeButtons.forEach(button => {
                button.addEventListener('click', (e) => {
                    applyTheme(e.target.dataset.theme);
                });
            });

            // Save all user data to localStorage
            function saveUserData() {
                localStorage.setItem('auralearn_user', JSON.stringify(mockData.user));
                // Convert Date objects to ISO strings for storage
                localStorage.setItem('auralearn_atoms', JSON.stringify(mockData.learningAtoms.map(a => ({
                    ...a,
                    lastReviewed: a.lastReviewed.toISOString(),
                    nextReview: a.nextReview.toISOString()
                }))));
                localStorage.setItem('auralearn_subjects', JSON.stringify(mockData.subjects));
                localStorage.setItem('auralearn_ai_materials', JSON.stringify(mockData.aiMaterials)); // Save new AI materials
            }

            // --- Initial application setup on load ---
            // A global error handler for any uncaught exceptions
            window.onerror = function(message, source, lineno, colno, error) {
                console.error("Global JavaScript Error:", { message, source, lineno, colno, error });
                showNotification('An unexpected error occurred. Check console for details.', true);
            };

            applyTheme(appState.currentTheme); // Apply theme first

            if (!appState.onboardingCompleted) {
                // Only reset to initial defaults if onboarding hasn't been completed before
                mockData.user = JSON.parse(JSON.stringify(initialUserData));
                mockData.learningAtoms = [];
                mockData.subjects = [];
                mockData.aiMaterials = []; // Ensure AI materials are reset too on fresh onboarding
                saveUserData(); // Save the reset state
                showOnboarding(); // Show onboarding flow
            } else {
                // If onboarding completed, just render the app
                usernameInput.value = mockData.user.name; // Set username input on load
                render(); // Render the main application
            }
        });
    </script>
</body>
</html>
